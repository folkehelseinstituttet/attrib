<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Nowcasting with Attrib • attrib</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Nowcasting with Attrib">
<meta property="og:description" content="attrib">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">attrib</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2021.5.31</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/intro.html">Introduction to Attrib</a>
    </li>
    <li>
      <a href="../articles/nowcast.html">Nowcasting with Attrib</a>
    </li>
    <li>
      <a href="../articles/statistical_properties.html">Statistical properties used in Attrib</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/folkehelseinstituttet/attrib/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="nowcast_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Nowcasting with Attrib</h1>
                        <h4 class="author">Aurora Christine Hofman</h4>
            
            <h4 class="date">2021-05-15</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/folkehelseinstituttet/attrib/blob/master/vignettes/nowcast.Rmd"><code>vignettes/nowcast.Rmd</code></a></small>
      <div class="hidden name"><code>nowcast.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/folkehelseinstituttet/attrib">attrib</a></span><span class="op">)</span>
<span class="co">#&gt; attrib 2021.5.31 https://folkehelseinstituttet.github.io/attrib</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span></code></pre></div>
<p>The nowcasting functions in <code>attrib</code> are made to correct for delay in registration. This vignette will go through how to use:</p>
<ul>
<li>
<code>nowcast_aggregate</code> to change registration data to aggregated weekly data,</li>
<li>
<code>nowcast</code> to correct for the delay in registration,</li>
<li>
<code>nowcast_eval</code> to evaluate the estimates made by <code>nowcast</code>,</li>
<li>
<code>baseline_est</code> to compare the estimate made by nowcast to what is expected.</li>
</ul>
<p>To do so we will use the delay in mortality registration in Norway as a example. All the data used in this example are fake data. We will show two examples of how to use <code>nowcast</code> one using a linear mixed model where the data is assumed to be negative binomial and one using a geneal linear model where the data is assumed to be quasipoisson.</p>
<p>Before we start it is important to note that all nowcasting functions only work with full weeks where the weeks start on mondays. The function <code>cut</code> is used to ensure this.</p>
<div id="aggregating-registration-data-using-nowcast_aggregate-" class="section level1">
<h1 class="hasAnchor">
<a href="#aggregating-registration-data-using-nowcast_aggregate-" class="anchor"></a>Aggregating registration data using <code>nowcast_aggregate</code>.</h1>
<p>For this example some fake mortality data has been generated.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">mortality_data_raw</span> <span class="op">&lt;-</span> <span class="fu">attrib</span><span class="fu">::</span><span class="va"><a href="../reference/data_fake_nowcasting_county_raw.html">data_fake_nowcasting_county_raw</a></span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">mortality_data_raw</span><span class="op">)</span>
<span class="co">#&gt;           doe        dor location_code</span>
<span class="co">#&gt; 1: 2018-01-01 2018-01-19      county03</span>
<span class="co">#&gt; 2: 2018-01-01 2018-01-18      county03</span>
<span class="co">#&gt; 3: 2018-01-01 2018-01-18      county03</span>
<span class="co">#&gt; 4: 2018-01-01 2018-01-24      county03</span>
<span class="co">#&gt; 5: 2018-01-01 2018-01-22      county03</span>
<span class="co">#&gt; 6: 2018-01-01 2018-01-18      county03</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="va">mortality_data_raw</span><span class="op">)</span>
<span class="co">#&gt;           doe        dor location_code</span>
<span class="co">#&gt; 1: 2019-12-30 2020-01-12      county54</span>
<span class="co">#&gt; 2: 2019-12-30 2020-01-19      county54</span>
<span class="co">#&gt; 3: 2019-12-30 2020-01-16      county54</span>
<span class="co">#&gt; 4: 2019-12-30 2020-01-26      county54</span>
<span class="co">#&gt; 5: 2019-12-30 2020-01-16      county54</span>
<span class="co">#&gt; 6: 2019-12-30 2020-01-16      county54</span></code></pre></div>
<p>As we can see this data set contains date of event “doe”, date of registration “dor” and “location_code”. To use <code>nowcast_aggregate</code> these columns must exist to be used as the first argument of <code>nowcast_aggregate</code>. The function also takes in the aggregation date, “aggregation_date”, the first date after the dataset has ended. We recall that even if the aggregation date is set to a Tuesday nowcast will convert this into a monday ensuring all weeks are compleate. In addition the number of weeks, “n_week”, for which we want to calculate the percentage of total registrations and the total number of registered events obtained for each week is an argument. The final argument is the population data, “pop_data”, a data set containing the population for each location code in the original data. This variable can be set to NULL.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">aggregation_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="st">"2020-01-01"</span><span class="op">)</span>
<span class="va">n_week</span> <span class="op">&lt;-</span> <span class="fl">6</span>
<span class="va">unique_locations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="fu">fhidata</span><span class="fu">::</span><span class="va"><a href="https://rdrr.io/pkg/fhidata/man/norway_locations_b2020.html">norway_locations_b2020</a></span><span class="op">$</span><span class="va">county_code</span><span class="op">)</span>
<span class="va">pop_data</span><span class="op">&lt;-</span> <span class="fu">fhidata</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/fhidata/man/norway_population_by_age_cats.html">norway_population_by_age_cats</a></span><span class="op">(</span>cats <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fl">120</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="va">location_code</span> <span class="op">%in%</span> <span class="va">unique_locations</span><span class="op">]</span>
<span class="va">mortality_data_aggregated</span> <span class="op">&lt;-</span>  <span class="fu">attrib</span><span class="fu">::</span><span class="fu"><a href="../reference/nowcast_aggregate.html">nowcast_aggregate</a></span><span class="op">(</span><span class="va">mortality_data_raw</span>,
                                               aggregation_date <span class="op">=</span> <span class="va">aggregation_date</span>, 
                                               n_week <span class="op">=</span> <span class="va">n_week</span>, pop_data <span class="op">=</span> <span class="va">pop_data</span> <span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="va">mortality_data_aggregated</span><span class="op">[</span><span class="va">location_code</span> <span class="op">==</span> <span class="st">"county03"</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt;       cut_doe location_code n_death n0_0 p0_0 n0_1       p0_1 n0_2      p0_2</span>
<span class="co">#&gt; 1: 2019-11-18      county03      12    0    0    1 0.08333333    8 0.6666667</span>
<span class="co">#&gt; 2: 2019-11-25      county03      14    0    0    1 0.07142857   11 0.7857143</span>
<span class="co">#&gt; 3: 2019-12-02      county03      12    0    0    2 0.16666667    7 0.5833333</span>
<span class="co">#&gt; 4: 2019-12-09      county03      11    0    0    6 0.54545455   11 1.0000000</span>
<span class="co">#&gt; 5: 2019-12-16      county03       1    0    0    1 1.00000000   NA        NA</span>
<span class="co">#&gt; 6: 2019-12-23      county03       0    0   NA   NA         NA   NA        NA</span>
<span class="co">#&gt;    n0_3      p0_3 n0_4 p0_4 n0_5 p0_5 week year    pop</span>
<span class="co">#&gt; 1:   12 1.0000000   12    1   12    1   47 2019 672069</span>
<span class="co">#&gt; 2:   13 0.9285714   14    1   NA   NA   48 2019 672069</span>
<span class="co">#&gt; 3:   12 1.0000000   NA   NA   NA   NA   49 2019 672069</span>
<span class="co">#&gt; 4:   NA        NA   NA   NA   NA   NA   50 2019 672069</span>
<span class="co">#&gt; 5:   NA        NA   NA   NA   NA   NA   51 2019 672069</span>
<span class="co">#&gt; 6:   NA        NA   NA   NA   NA   NA   52 2019 672069</span></code></pre></div>
<p>As we can see we have now generated a data table containing the number of registered deaths per week for all weeks and locations between the first date in the dataset and the week before the aggregation date. The data table contains the variables “cut_doe”, the date of the Monday belonging to each week, “p0_i” the percentage of registered deaths and “n0_i” the number of deaths registered within all weeks up to “n_week”. The population, “pop”, “year” and “week” are also added to the data.</p>
<p>It is worth noting that “n0_0” is defined as the number of moralities registered in the last full week before “cut_doe” which is always a Monday. This means that “n0_0” also contains information from a full week. The information contained in “n0_1” are all moralities registered within the last and the second last week. Hence this contains the moralities registered withing 2 weeks from the “cut_doe”.</p>
<p>We also note that for the last weeks in the data set we do not have information about what happens in the future, hence these are set to “NA”.</p>
<p>We can now plot the percentages of registrations after <span class="math inline">\(k\)</span> weeks and use this to evaluate how many weeks we need to correct.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">mortality_data_aggregated</span><span class="op">[</span><span class="va">location_code</span> <span class="op">==</span> <span class="st">"county03"</span><span class="op">]</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">cut_doe</span>, y <span class="op">=</span> <span class="va">p0_2</span><span class="op">)</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> 
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span><span class="st">"Percentage of deaths registered\n within 2 weeks"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle<span class="op">=</span><span class="fl">90</span><span class="op">)</span><span class="op">)</span>
<span class="va">q</span></code></pre></div>
<p><img src="nowcast_files/figure-html/unnamed-chunk-5-1.png" width="576"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">mortality_data_aggregated</span><span class="op">[</span><span class="va">location_code</span> <span class="op">==</span> <span class="st">"county03"</span><span class="op">]</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">cut_doe</span>, y <span class="op">=</span> <span class="va">p0_3</span><span class="op">)</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span><span class="st">"Percentage of deaths registered\n  within 3 weeks"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.5</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle<span class="op">=</span><span class="fl">90</span><span class="op">)</span><span class="op">)</span>
<span class="va">q</span></code></pre></div>
<p><img src="nowcast_files/figure-html/unnamed-chunk-6-1.png" width="576"></p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">mortality_data_aggregated</span><span class="op">[</span><span class="va">location_code</span> <span class="op">==</span> <span class="st">"county03"</span><span class="op">]</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">cut_doe</span>, y <span class="op">=</span> <span class="va">p0_4</span><span class="op">)</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span><span class="st">"Percentage of deaths registered\n  within 4 weeks"</span>, limits <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">0.8</span>,<span class="fl">1</span><span class="op">)</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.title.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span>, axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle<span class="op">=</span><span class="fl">90</span><span class="op">)</span><span class="op">)</span>
<span class="va">q</span></code></pre></div>
<p><img src="nowcast_files/figure-html/unnamed-chunk-7-1.png" width="576"></p>
<p>We can see that for this fake dataset we have around <span class="math inline">\(80 \%\)</span> of the registrations after 3 weeks and a $100 % $ after 5 weeks.</p>
</div>
<div id="using-nowcast-to-correct-n_deaths-assuming-data-to-be-negative-binomial-" class="section level1">
<h1 class="hasAnchor">
<a href="#using-nowcast-to-correct-n_deaths-assuming-data-to-be-negative-binomial-" class="anchor"></a>Using <code>nowcast</code> to correct n_deaths assuming data to be negative binomial.</h1>
<p>When we have a data frame either generated by <code>nowcast_aggregate</code>, or on the same form as shown above, we can use <code>nowcast</code> to correct for the delay in registration. We set how many week we want to adjust. If “n_week_adjust” = 5 then the current week and the prior 4 weeks are corrected. Meaning 5 weeks in total. We also set how many weeks we want to train the model on. Note that we assume all the weeks before the weeks we state to be adjusted to be the true data. In other words we assume 100 % of the deaths to be present. If in doubt set “n_week_adjust” a bit higher.</p>
<p>In our case as seen from the plots after 5 weeks almost 100 % of the data are registered and we therefor chose to correct only 5 weeks.</p>
<p>We use the default functions for “nowcast_correction_fn” and <code>nowcast_correction_fn_negbin_mm</code>, however these can be manually set as long as they full fill certain conditions. The function must have the following arguments:</p>
<ul>
<li><p>data, a dataset generated by <code>nowcast_aggregate</code> or on the same form</p></li>
<li><p>n_week_adjusting, the number of weeks to be adjustd</p></li>
<li><p>offset</p></li>
<li><p>date_0, the last date in the dataset.</p></li>
</ul>
<p>The function must return a vector containing the following:</p>
<ul>
<li><p>data, the corrected data set containing the columns ncor, ncor0_1 up to ncor0_n_week_adjusting</p></li>
<li><p>n_week_adjusting number of weeks that where adjusted</p></li>
<li><p>fit &lt;- a vector containgin a fit for each correction, (one per week in n_week_adjusting).</p></li>
</ul>
<p>We also use the default simulation function <code>nowcast_correction_sim_neg_bin</code>. This can also be set manually but must contain the following arguments:</p>
<ul>
<li><p>nowcast_correction_object made by “nowcast_correction_fn”</p></li>
<li><p>offset,</p></li>
<li><p>n_sim, number of simulations</p></li>
<li><p>date_0, the last date in the data set.</p></li>
</ul>
<p>It must return the following a dataset containing the following rows:</p>
<ul>
<li><p>yrwk, yearweek</p></li>
<li><p>n_death, number of observed deaths</p></li>
<li><p>sim_value, predicted number of deaths from one simulation</p></li>
<li><p>cut_doe, first date of every week</p></li>
<li><p>week</p></li>
<li><p>year</p></li>
<li><p>location_code</p></li>
<li><p>sim_id, simmulation id</p></li>
</ul>
<p>It is also important to make sure that the simulation function works together with the chosen correction function.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_aggregated</span> <span class="op">&lt;-</span> <span class="va">mortality_data_aggregated</span>
<span class="va">n_week_training</span> <span class="op">&lt;-</span> <span class="fl">50</span>
<span class="va">n_week_adjusting</span> <span class="op">&lt;-</span> <span class="fl">4</span>
<span class="va">date_0</span> <span class="op">&lt;-</span> <span class="va">aggregation_date</span>
<span class="va">nowcast_correction_fn</span><span class="op">&lt;-</span> <span class="va">nowcast_correction_fn_negbin_mm</span>
<span class="va">nowcast_correction_sim_fn</span> <span class="op">=</span> <span class="va">nowcast_correction_sim_neg_bin</span>
<span class="va">offset</span> <span class="op">=</span> <span class="st">"log(pop)"</span>
<span class="va">nowcast_object_negbin</span> <span class="op">&lt;-</span>  <span class="fu">attrib</span><span class="fu">::</span><span class="fu"><a href="../reference/nowcast.html">nowcast</a></span><span class="op">(</span><span class="va">data_aggregated</span>,
  <span class="va">offset</span>,
  <span class="va">n_week_adjusting</span>,
  <span class="va">n_week_training</span>,
  <span class="va">date_0</span>,
  nowcast_correction_fn <span class="op">=</span> <span class="va">nowcast_correction_fn_negbin_mm</span>,
  nowcast_correction_sim_fn <span class="op">=</span> <span class="va">nowcast_correction_sim_neg_bin</span><span class="op">)</span></code></pre></div>
<p><code>nowcast</code> returns two datasets. One being the original dataset with the median of the corrected data added and the other containing simulations for the predicted value of ncor so one can make credible intervals.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="va">nowcast_object_negbin</span><span class="op">$</span><span class="va">data</span><span class="op">[</span><span class="va">location_code</span> <span class="op">==</span> <span class="st">"county03"</span><span class="op">]</span><span class="op">)</span>
<span class="co">#&gt;       yrwk location_code n_death ncor    cut_doe n0_0 p0_0 n0_1       p0_1 n0_2</span>
<span class="co">#&gt; 1: 2019-47      county03      12   12 2019-11-18    0    0    1 0.08333333    8</span>
<span class="co">#&gt; 2: 2019-48      county03      14   14 2019-11-25    0    0    1 0.07142857   11</span>
<span class="co">#&gt; 3: 2019-49      county03      12   12 2019-12-02    0    0    2 0.16666667    7</span>
<span class="co">#&gt; 4: 2019-50      county03      11   15 2019-12-09    0    0    6 0.54545455   11</span>
<span class="co">#&gt; 5: 2019-51      county03       1   13 2019-12-16    0    0    1 1.00000000   NA</span>
<span class="co">#&gt; 6: 2019-52      county03       0   14 2019-12-23    0   NA   NA         NA   NA</span>
<span class="co">#&gt;         p0_2 n0_3      p0_3 n0_4 p0_4 n0_5 p0_5 week year    pop n0_0_lag1</span>
<span class="co">#&gt; 1: 0.6666667   12 1.0000000   12    1   12    1   47 2019 672069         0</span>
<span class="co">#&gt; 2: 0.7857143   13 0.9285714   14    1   NA   NA   48 2019 672069         0</span>
<span class="co">#&gt; 3: 0.5833333   12 1.0000000   NA   NA   NA   NA   49 2019 672069         0</span>
<span class="co">#&gt; 4: 1.0000000   NA        NA   NA   NA   NA   NA   50 2019 672069         0</span>
<span class="co">#&gt; 5:        NA   NA        NA   NA   NA   NA   NA   51 2019 672069         0</span>
<span class="co">#&gt; 6:        NA   NA        NA   NA   NA   NA   NA   52 2019 672069         0</span>
<span class="co">#&gt;    n0_1_lag1 n0_2_lag1 n0_3_lag1 ncor0_0 ncor0_1 ncor0_2 ncor0_3</span>
<span class="co">#&gt; 1:         0         8        11      13      13      12      12</span>
<span class="co">#&gt; 2:         1         8        12      13      13      15      13</span>
<span class="co">#&gt; 3:         1        11        13      13      14      11      12</span>
<span class="co">#&gt; 4:         2         7        12      14      18      15      NA</span>
<span class="co">#&gt; 5:         6        11        NA      14      13      NA      NA</span>
<span class="co">#&gt; 6:         1        NA        NA      14      NA      NA      NA</span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">nowcast_object_negbin</span><span class="op">$</span><span class="va">data_sim</span><span class="op">)</span>
<span class="co">#&gt;       yrwk n_death sim_value    cut_doe week year location_code sim_id</span>
<span class="co">#&gt; 1: 2019-49       1         3 2019-12-02   49 2019      county42      1</span>
<span class="co">#&gt; 2: 2019-49       1         4 2019-12-02   49 2019      county42      2</span>
<span class="co">#&gt; 3: 2019-49       1         5 2019-12-02   49 2019      county42      3</span>
<span class="co">#&gt; 4: 2019-49       1         5 2019-12-02   49 2019      county42      4</span>
<span class="co">#&gt; 5: 2019-49       1         1 2019-12-02   49 2019      county42      5</span>
<span class="co">#&gt; 6: 2019-49       1         3 2019-12-02   49 2019      county42      6</span></code></pre></div>
</div>
<div id="evaluating-the-nowcast-negative-binomial-estimates-" class="section level1">
<h1 class="hasAnchor">
<a href="#evaluating-the-nowcast-negative-binomial-estimates-" class="anchor"></a>Evaluating the <code>nowcast</code> negative binomial estimates.</h1>
<p>To evaluate the estimates made by <code>nowcast</code> an evaluation function is made. The function takes a “nowcast_object” and the number of weeks to adjust “n_week_adjusting” as arguments.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nowcast_eval_object_negbin</span> <span class="op">&lt;-</span>  <span class="fu">attrib</span><span class="fu">::</span><span class="fu"><a href="../reference/nowcast_eval.html">nowcast_eval</a></span><span class="op">(</span><span class="va">nowcast_object_negbin</span>, <span class="va">n_week_adjusting</span><span class="op">)</span></code></pre></div>
<p>We can evaluate all the residual plots to make sure there is no bias. Here we see the residualplot for n corrected in week 2.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nowcast_eval_object_negbin</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">std_residualplot</span></code></pre></div>
<p><img src="nowcast_files/figure-html/unnamed-chunk-12-1.png" width="576"></p>
<p>If the resuduals do not show any bias we look at the accuratcy of the predictions using the absolute error (“abs_error”), <span class="math inline">\(R^2\)</span> (“R_squared”), mean square error (“MSE”), and the root mean square error (“RMSE”).</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model_data_negbin</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>
  ncor <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="va">n_week_adjusting</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>
<span class="op">)</span>

<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="va">n_week_adjusting</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">model_data_negbin</span><span class="op">[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span>, <span class="va">abs_error</span> <span class="op">:=</span> <span class="va">nowcast_eval_object_negbin</span><span class="op">[[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">abs_error</span><span class="op">]</span>
  <span class="va">model_data_negbin</span><span class="op">[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span>, <span class="va">R_squared</span> <span class="op">:=</span> <span class="va">nowcast_eval_object_negbin</span><span class="op">[[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">R_squared</span><span class="op">]</span>
  <span class="va">model_data_negbin</span><span class="op">[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span>, <span class="va">MSE</span> <span class="op">:=</span> <span class="va">nowcast_eval_object_negbin</span><span class="op">[[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">MSE</span><span class="op">]</span>
  <span class="va">model_data_negbin</span><span class="op">[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span>, <span class="va">RMSE</span> <span class="op">:=</span> <span class="va">nowcast_eval_object_negbin</span><span class="op">[[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">RMSE</span><span class="op">]</span>
<span class="op">}</span>

<span class="va">model_data_negbin</span>
<span class="va">model_data_negbin</span>
<span class="co">#&gt;    ncor abs_error R_squared      MSE     RMSE</span>
<span class="co">#&gt; 1:    0  2.970260 0.7467541 9.698885 3.114303</span>
<span class="co">#&gt; 2:    1  2.596654 0.7773300 8.527881 2.920254</span>
<span class="co">#&gt; 3:    2  1.741636 0.8645926 5.185874 2.277251</span>
<span class="co">#&gt; 4:    3  1.169145 0.9044383 3.659851 1.913074</span></code></pre></div>
</div>
<div id="using-nowcast-to-correct-n_deaths-assuming-data-to-be-quasi-poisson-" class="section level1">
<h1 class="hasAnchor">
<a href="#using-nowcast-to-correct-n_deaths-assuming-data-to-be-quasi-poisson-" class="anchor"></a>Using <code>nowcast</code> to correct n_deaths assuming data to be quasi poisson.</h1>
<p>Instead of modeling all locations at once we can model them one by one using <code>nowcast_correction_fn_quasipoisson</code> and <code>nowcast_correction_sim_quasipoisson</code>. We will show this only for one location. However this could be done for all locations. If the resulting datasets are merged the results can be compared to the above example.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">n_week_adjusting</span> <span class="op">&lt;-</span> <span class="fl">5</span>
<span class="va">n_week_training</span> <span class="op">&lt;-</span> <span class="fl">52</span>
<span class="va">offset</span> <span class="op">&lt;-</span> <span class="st">"log(pop)"</span>
<span class="va">date_0</span> <span class="op">&lt;-</span> <span class="va">aggregation_date</span>
<span class="va">nowcast_object_glm</span> <span class="op">&lt;-</span>  <span class="fu">attrib</span><span class="fu">::</span><span class="fu"><a href="../reference/nowcast.html">nowcast</a></span><span class="op">(</span><span class="va">mortality_data_aggregated</span><span class="op">[</span><span class="va">location_code</span> <span class="op">==</span> <span class="st">"county03"</span><span class="op">]</span>,
  <span class="va">offset</span>,
  <span class="va">n_week_adjusting</span>,
  <span class="va">n_week_training</span>,
  <span class="va">date_0</span>,
  nowcast_correction_fn <span class="op">=</span> <span class="va">nowcast_correction_fn_quasipoisson</span>,
  nowcast_correction_sim_fn <span class="op">=</span> <span class="va">nowcast_correction_sim_quasipoisson</span><span class="op">)</span></code></pre></div>
<p>As shown above the same two datasets are returned</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">tail</a></span><span class="op">(</span><span class="va">nowcast_object_glm</span><span class="op">$</span><span class="va">data</span><span class="op">)</span>
<span class="co">#&gt;       yrwk location_code n_death ncor    cut_doe n0_0 p0_0 n0_1       p0_1 n0_2</span>
<span class="co">#&gt; 1: 2019-47      county03      12   12 2019-11-18    0    0    1 0.08333333    8</span>
<span class="co">#&gt; 2: 2019-48      county03      14   13 2019-11-25    0    0    1 0.07142857   11</span>
<span class="co">#&gt; 3: 2019-49      county03      12   12 2019-12-02    0    0    2 0.16666667    7</span>
<span class="co">#&gt; 4: 2019-50      county03      11   14 2019-12-09    0    0    6 0.54545455   11</span>
<span class="co">#&gt; 5: 2019-51      county03       1   13 2019-12-16    0    0    1 1.00000000   NA</span>
<span class="co">#&gt; 6: 2019-52      county03       0   14 2019-12-23    0   NA   NA         NA   NA</span>
<span class="co">#&gt;         p0_2 n0_3      p0_3 n0_4 p0_4 n0_5 p0_5 week year    pop n0_0_lag1</span>
<span class="co">#&gt; 1: 0.6666667   12 1.0000000   12    1   12    1   47 2019 672069         0</span>
<span class="co">#&gt; 2: 0.7857143   13 0.9285714   14    1   NA   NA   48 2019 672069         0</span>
<span class="co">#&gt; 3: 0.5833333   12 1.0000000   NA   NA   NA   NA   49 2019 672069         0</span>
<span class="co">#&gt; 4: 1.0000000   NA        NA   NA   NA   NA   NA   50 2019 672069         0</span>
<span class="co">#&gt; 5:        NA   NA        NA   NA   NA   NA   NA   51 2019 672069         0</span>
<span class="co">#&gt; 6:        NA   NA        NA   NA   NA   NA   NA   52 2019 672069         0</span>
<span class="co">#&gt;    n0_1_lag1 n0_2_lag1 n0_3_lag1 n0_4_lag1 ncor0_0 ncor0_1 ncor0_2 ncor0_3</span>
<span class="co">#&gt; 1:         0         8        11        11      13      13      12      12</span>
<span class="co">#&gt; 2:         1         8        12        12      13      13      14      13</span>
<span class="co">#&gt; 3:         1        11        13        14      13      14      11      12</span>
<span class="co">#&gt; 4:         2         7        12        NA      14      16      14      NA</span>
<span class="co">#&gt; 5:         6        11        NA        NA      14      13      NA      NA</span>
<span class="co">#&gt; 6:         1        NA        NA        NA      14      NA      NA      NA</span>
<span class="co">#&gt;    ncor0_4</span>
<span class="co">#&gt; 1:      12</span>
<span class="co">#&gt; 2:      13</span>
<span class="co">#&gt; 3:      NA</span>
<span class="co">#&gt; 4:      NA</span>
<span class="co">#&gt; 5:      NA</span>
<span class="co">#&gt; 6:      NA</span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">nowcast_object_glm</span><span class="op">$</span><span class="va">data_sim</span><span class="op">)</span>
<span class="co">#&gt;       yrwk n_death sim_value    cut_doe week year location_code sim_id</span>
<span class="co">#&gt; 1: 2019-48      14        17 2019-11-25   48 2019      county03      1</span>
<span class="co">#&gt; 2: 2019-48      14        13 2019-11-25   48 2019      county03      2</span>
<span class="co">#&gt; 3: 2019-48      14        20 2019-11-25   48 2019      county03      3</span>
<span class="co">#&gt; 4: 2019-48      14        14 2019-11-25   48 2019      county03      4</span>
<span class="co">#&gt; 5: 2019-48      14        15 2019-11-25   48 2019      county03      5</span>
<span class="co">#&gt; 6: 2019-48      14        16 2019-11-25   48 2019      county03      6</span></code></pre></div>
</div>
<div id="evaluating-the-nowcast-quasipoisson-estimates-" class="section level1">
<h1 class="hasAnchor">
<a href="#evaluating-the-nowcast-quasipoisson-estimates-" class="anchor"></a>Evaluating the <code>nowcast</code> quasipoisson estimates.</h1>
<p>We also follow the same evaluation presidure as above.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nowcast_eval_object_glm</span> <span class="op">&lt;-</span>  <span class="fu">attrib</span><span class="fu">::</span><span class="fu"><a href="../reference/nowcast_eval.html">nowcast_eval</a></span><span class="op">(</span><span class="va">nowcast_object_glm</span>, <span class="va">n_week_adjusting</span><span class="op">)</span></code></pre></div>
<p>We can evaluate all the residual plots to make sure there is no bias. Here we see the residualplot for n corrected in week 2.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nowcast_eval_object_glm</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">std_residualplot</span></code></pre></div>
<p><img src="nowcast_files/figure-html/unnamed-chunk-18-1.png" width="576"></p>
<p>If the resuduals do not show any bias we look at the accuratcy of the predictions using the absolute error (“abs_error”), <span class="math inline">\(R^2\)</span> (“R_squared”), mean square error (“MSE”), and the root mean square error (“RMSE”).</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">model_data_glm</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/data.table.html">data.table</a></span><span class="op">(</span>
  ncor <span class="op">=</span> <span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="va">n_week_adjusting</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span>
<span class="op">)</span>

<span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">0</span><span class="op">:</span><span class="op">(</span><span class="va">n_week_adjusting</span><span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
  <span class="va">model_data_glm</span><span class="op">[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span>, <span class="va">abs_error</span> <span class="op">:=</span> <span class="va">nowcast_eval_object_glm</span><span class="op">[[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">abs_error</span><span class="op">]</span>
  <span class="va">model_data_glm</span><span class="op">[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span>, <span class="va">R_squared</span> <span class="op">:=</span> <span class="va">nowcast_eval_object_glm</span><span class="op">[[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">R_squared</span><span class="op">]</span>
  <span class="va">model_data_glm</span><span class="op">[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span>, <span class="va">MSE</span> <span class="op">:=</span> <span class="va">nowcast_eval_object_glm</span><span class="op">[[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">MSE</span><span class="op">]</span>
  <span class="va">model_data_glm</span><span class="op">[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span>, <span class="va">RMSE</span> <span class="op">:=</span> <span class="va">nowcast_eval_object_glm</span><span class="op">[[</span><span class="va">i</span><span class="op">+</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">RMSE</span><span class="op">]</span>
<span class="op">}</span>

<span class="va">model_data_glm</span>
<span class="va">model_data_glm</span>
<span class="co">#&gt;    ncor abs_error R_squared       MSE      RMSE</span>
<span class="co">#&gt; 1:    0 2.6730769 0.2439001 7.5192308 2.7421216</span>
<span class="co">#&gt; 2:    1 2.3846154 0.2999791 6.9615385 2.6384728</span>
<span class="co">#&gt; 3:    2 1.5961538 0.6422545 3.5576923 1.8861846</span>
<span class="co">#&gt; 4:    3 0.4038462 0.9613248 0.3846154 0.6201737</span>
<span class="co">#&gt; 5:    4 0.1923077 0.9787286 0.2115385 0.4599331</span></code></pre></div>
</div>
<div id="basline-estimation-of-mortality" class="section level1">
<h1 class="hasAnchor">
<a href="#basline-estimation-of-mortality" class="anchor"></a>Basline estimation of mortality</h1>
<p>We use the aggregated mortality data to make an estimate of expected mortality for each week and year using <code>baseline_est</code>.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">data_train</span> <span class="op">&lt;-</span> <span class="va">mortality_data_aggregated</span><span class="op">[</span><span class="va">cut_doe</span><span class="op">&lt;</span> <span class="st">"2019-06-30"</span><span class="op">]</span>
<span class="va">data_predict</span> <span class="op">&lt;-</span> <span class="va">mortality_data_aggregated</span>


<span class="va">n_sim</span> <span class="op">&lt;-</span> <span class="fl">1000</span>

<span class="va">response</span> <span class="op">&lt;-</span> <span class="st">"n_death"</span>
<span class="va">fixef</span> <span class="op">&lt;-</span> <span class="st">"1 + sin(2 * pi * (week) / 53) + cos(2 * pi * (week ) / 53) + year"</span>
<span class="va">ranef</span> <span class="op">&lt;-</span> <span class="st">"(1|location_code)"</span>
<span class="va">offset</span> <span class="op">&lt;-</span> <span class="st">"log(pop)"</span>


<span class="va">base_line</span> <span class="op">&lt;-</span>  <span class="fu">attrib</span><span class="fu">::</span><span class="fu"><a href="../reference/baseline_est.html">baseline_est</a></span><span class="op">(</span><span class="va">data_train</span>, 
                                   <span class="va">data_predict</span>, 
                                   fixef <span class="op">=</span> <span class="va">fixef</span>, 
                                   ranef <span class="op">=</span> <span class="va">ranef</span>, 
                                   response <span class="op">=</span> <span class="va">response</span>, 
                                   offset <span class="op">=</span> <span class="va">offset</span><span class="op">)</span></code></pre></div>
<p>We then use both data tables generated from the <code>nowcast</code> function and compare the results to the baseline estimate.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nowcast_data_negbin</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">nowcast_object_negbin</span><span class="op">$</span><span class="va">data</span><span class="op">)</span>
<span class="va">nowcast_sim_negbin</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">nowcast_object_negbin</span><span class="op">$</span><span class="va">data_sim</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Quantile functions</span>
<span class="va">q025</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0.025</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">q975</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>We need to aggregate the simulated data from <code>nowcast</code>. We first use the negative binomial estimates.</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">col_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">nowcast_sim_negbin</span><span class="op">)</span>
<span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setkey.html">setkeyv</a></span><span class="op">(</span><span class="va">nowcast_sim_negbin</span>,
                    <span class="va">col_names</span><span class="op">[</span><span class="op">!</span><span class="va">col_names</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sim_value"</span>, <span class="st">"sim_id"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>

<span class="va">aggregated_nowcast_sim_negbin</span><span class="op">&lt;-</span> <span class="va">nowcast_sim_negbin</span><span class="op">[</span>,
                                   <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span>recursive <span class="op">=</span> <span class="cn">FALSE</span>,
                                          <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu">.</span><span class="op">(</span>median <span class="op">=</span> <span class="va">median</span>, q025 <span class="op">=</span> <span class="va">q025</span>, q975 <span class="op">=</span> <span class="va">q975</span><span class="op">)</span>,
                                                                    <span class="kw">function</span><span class="op">(</span><span class="va">f</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">f</span><span class="op">)</span>
                                   <span class="op">)</span><span class="op">)</span>,
                                   by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span><span class="op">(</span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setkey.html">key</a></span><span class="op">(</span><span class="va">nowcast_sim_negbin</span><span class="op">)</span><span class="op">)</span>,
                                   .SDcols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sim_value"</span><span class="op">)</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">aggregated_nowcast_sim_negbin</span><span class="op">)</span>
<span class="co">#&gt;       yrwk n_death    cut_doe week year location_code median.sim_value</span>
<span class="co">#&gt; 1: 2019-49       1 2019-12-02   49 2019      county42                4</span>
<span class="co">#&gt; 2: 2019-49       6 2019-12-02   49 2019      county50                6</span>
<span class="co">#&gt; 3: 2019-49       6 2019-12-02   49 2019      county15                6</span>
<span class="co">#&gt; 4: 2019-49       6 2019-12-02   49 2019      county18                6</span>
<span class="co">#&gt; 5: 2019-49      11 2019-12-02   49 2019      county46               11</span>
<span class="co">#&gt; 6: 2019-49      12 2019-12-02   49 2019      county03               12</span>
<span class="co">#&gt;    q025.sim_value q975.sim_value</span>
<span class="co">#&gt; 1:          1.000              8</span>
<span class="co">#&gt; 2:          2.000             12</span>
<span class="co">#&gt; 3:          2.000             11</span>
<span class="co">#&gt; 4:          1.475             12</span>
<span class="co">#&gt; 5:          5.000             18</span>
<span class="co">#&gt; 6:          6.000             19</span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#nowcast_data[, q025.sim_value := ncor]</span>
<span class="va">nowcast_data_negbin</span><span class="op">[</span><span class="va">aggregated_nowcast_sim_negbin</span>, 
                    on <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">cut_doe</span>,<span class="va">location_code</span><span class="op">)</span>, 
                    <span class="va">q025.sim_value</span> <span class="op">:=</span> <span class="va">q025.sim_value</span><span class="op">]</span>

<span class="co">#nowcast_data[, q975.sim_value := ncor]</span>
<span class="va">nowcast_data_negbin</span><span class="op">[</span><span class="va">aggregated_nowcast_sim_negbin</span>, 
                    on <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">cut_doe</span>,<span class="va">location_code</span><span class="op">)</span>, 
                    <span class="va">q975.sim_value</span> <span class="op">:=</span> <span class="va">q975.sim_value</span><span class="op">]</span></code></pre></div>
<p>Finally we can plot the baseline estimate together with the nowcast predictions to see if the mortality falls withing the expected values.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">base_line</span><span class="op">$</span><span class="va">aggregated</span><span class="op">[</span><span class="va">year</span> <span class="op">==</span> <span class="st">"2019"</span> <span class="op">&amp;</span> <span class="va">location_code</span> <span class="op">==</span> <span class="st">"county03"</span><span class="op">]</span>,
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">week</span>,
                y <span class="op">=</span> <span class="va">median.sim_value</span><span class="op">)</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">base_line</span><span class="op">$</span><span class="va">aggregated</span><span class="op">[</span><span class="va">year</span><span class="op">==</span> <span class="fl">2019</span> <span class="op">&amp;</span> <span class="va">location_code</span> <span class="op">==</span> <span class="st">"county03"</span><span class="op">]</span>,
                     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">week</span>, ymin<span class="op">=</span><span class="va">q025.sim_value</span>,
                         ymax<span class="op">=</span><span class="va">q975.sim_value</span>,
                         colour <span class="op">=</span> <span class="st">"Baseline estimate"</span>,
                         fill <span class="op">=</span><span class="st">"Baseline estimate"</span><span class="op">)</span>,
                     alpha<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">nowcast_data_negbin</span><span class="op">[</span><span class="va">year</span> <span class="op">==</span> <span class="st">"2019"</span><span class="op">&amp;</span> <span class="va">location_code</span> <span class="op">==</span> <span class="st">"county03"</span><span class="op">]</span>,
                   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">week</span>, y <span class="op">=</span> <span class="va">ncor</span>,  colour <span class="op">=</span> <span class="st">"Number of deaths corrected"</span> <span class="op">)</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">nowcast_data_negbin</span><span class="op">[</span><span class="va">location_code</span> <span class="op">==</span> <span class="st">"county03"</span> <span class="op">&amp;</span> <span class="va">cut_doe</span><span class="op">&gt;</span> <span class="op">(</span><span class="va">date_0</span><span class="op">-</span> <span class="fl">5</span><span class="op">*</span><span class="fl">7</span><span class="op">)</span><span class="op">]</span>,
                   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">week</span>, y <span class="op">=</span> <span class="va">q025.sim_value</span> ,colour <span class="op">=</span> <span class="st">"Credible intervall for n corrected"</span> <span class="op">)</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">nowcast_data_negbin</span><span class="op">[</span><span class="va">location_code</span> <span class="op">==</span> <span class="st">"county03"</span> <span class="op">&amp;</span> <span class="va">cut_doe</span><span class="op">&gt;</span> <span class="op">(</span><span class="va">date_0</span><span class="op">-</span> <span class="fl">5</span><span class="op">*</span><span class="fl">7</span><span class="op">)</span><span class="op">]</span>,
                   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">week</span>, y <span class="op">=</span> <span class="va">q975.sim_value</span>, colour <span class="op">=</span> <span class="st">"Credible intervall for n corrected"</span> <span class="op">)</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Number of deaths"</span><span class="op">)</span><span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>, legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">FALSE</span>, colour<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>nrow<span class="op">=</span><span class="fl">2</span>,byrow<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="va">q</span></code></pre></div>
<p><img src="nowcast_files/figure-html/unnamed-chunk-25-1.png" width="576"></p>
<p>We now look at the quasipoisson estimates and follow the same procedure.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">nowcast_data_glm</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">nowcast_object_glm</span><span class="op">$</span><span class="va">data</span><span class="op">)</span>
<span class="va">nowcast_sim_glm</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="va">nowcast_object_glm</span><span class="op">$</span><span class="va">data_sim</span><span class="op">)</span></code></pre></div>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">col_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">nowcast_sim_glm</span><span class="op">)</span>
<span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setkey.html">setkeyv</a></span><span class="op">(</span><span class="va">nowcast_sim_glm</span>,
                    <span class="va">col_names</span><span class="op">[</span><span class="op">!</span><span class="va">col_names</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sim_value"</span>, <span class="st">"sim_id"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>

<span class="va">aggregated_nowcast_sim_glm</span><span class="op">&lt;-</span> <span class="va">nowcast_sim_glm</span><span class="op">[</span>,
                                   <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span>recursive <span class="op">=</span> <span class="cn">FALSE</span>,
                                          <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu">.</span><span class="op">(</span>median <span class="op">=</span> <span class="va">median</span>, q025 <span class="op">=</span> <span class="va">q025</span>, q975 <span class="op">=</span> <span class="va">q975</span><span class="op">)</span>,
                                                                    <span class="kw">function</span><span class="op">(</span><span class="va">f</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">f</span><span class="op">)</span>
                                   <span class="op">)</span><span class="op">)</span>,
                                   by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span><span class="op">(</span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setkey.html">key</a></span><span class="op">(</span><span class="va">nowcast_sim_glm</span><span class="op">)</span><span class="op">)</span>,
                                   .SDcols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sim_value"</span><span class="op">)</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">aggregated_nowcast_sim_glm</span><span class="op">)</span>
<span class="co">#&gt;       yrwk n_death    cut_doe week year location_code median.sim_value</span>
<span class="co">#&gt; 1: 2019-48      14 2019-11-25   48 2019      county03               13</span>
<span class="co">#&gt; 2: 2019-49      12 2019-12-02   49 2019      county03               12</span>
<span class="co">#&gt; 3: 2019-50      11 2019-12-09   50 2019      county03               14</span>
<span class="co">#&gt; 4: 2019-51       1 2019-12-16   51 2019      county03               12</span>
<span class="co">#&gt; 5: 2019-52       0 2019-12-23   52 2019      county03               14</span>
<span class="co">#&gt;    q025.sim_value q975.sim_value</span>
<span class="co">#&gt; 1:              7         20.525</span>
<span class="co">#&gt; 2:              6         19.000</span>
<span class="co">#&gt; 3:              7         21.525</span>
<span class="co">#&gt; 4:              6         20.000</span>
<span class="co">#&gt; 5:              7         22.000</span></code></pre></div>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"> 
<span class="co">#nowcast_data[, q025.sim_value := ncor]</span>
<span class="va">nowcast_data_glm</span><span class="op">[</span><span class="va">aggregated_nowcast_sim_glm</span>, 
                 on <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">cut_doe</span>,<span class="va">location_code</span><span class="op">)</span>, 
                 <span class="va">q025.sim_value</span> <span class="op">:=</span> <span class="va">q025.sim_value</span><span class="op">]</span>
<span class="co">#nowcast_data[, q975.sim_value := ncor]</span>
<span class="va">nowcast_data_glm</span><span class="op">[</span><span class="va">aggregated_nowcast_sim_glm</span>,
                 on <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">cut_doe</span>,<span class="va">location_code</span><span class="op">)</span>, 
                 <span class="va">q975.sim_value</span> <span class="op">:=</span> <span class="va">q975.sim_value</span><span class="op">]</span></code></pre></div>
<p>Again we can plot the baseline and the nowcast estimates together to see if the mortality falls withing the expected values.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">base_line</span><span class="op">$</span><span class="va">aggregated</span><span class="op">[</span><span class="va">year</span> <span class="op">==</span> <span class="st">"2019"</span> <span class="op">&amp;</span> <span class="va">location_code</span> <span class="op">==</span> <span class="st">"county03"</span><span class="op">]</span>,
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">week</span>,
                y <span class="op">=</span> <span class="va">median.sim_value</span><span class="op">)</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">base_line</span><span class="op">$</span><span class="va">aggregated</span><span class="op">[</span><span class="va">year</span><span class="op">==</span> <span class="fl">2019</span> <span class="op">&amp;</span> <span class="va">location_code</span> <span class="op">==</span> <span class="st">"county03"</span><span class="op">]</span>,
                     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">week</span>, ymin<span class="op">=</span><span class="va">q025.sim_value</span>,
                         ymax<span class="op">=</span><span class="va">q975.sim_value</span>,
                         colour <span class="op">=</span> <span class="st">"Baseline estimate"</span>,
                         fill <span class="op">=</span><span class="st">"Baseline estimate"</span><span class="op">)</span>,
                     alpha<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">nowcast_data_glm</span><span class="op">[</span><span class="va">year</span> <span class="op">==</span> <span class="st">"2019"</span><span class="op">&amp;</span> <span class="va">location_code</span> <span class="op">==</span> <span class="st">"county03"</span><span class="op">]</span>,
                   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">week</span>, y <span class="op">=</span> <span class="va">ncor</span>,  colour <span class="op">=</span> <span class="st">"Number of deaths corrected"</span> <span class="op">)</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">nowcast_data_glm</span><span class="op">[</span><span class="va">location_code</span> <span class="op">==</span> <span class="st">"county03"</span> <span class="op">&amp;</span> <span class="va">cut_doe</span><span class="op">&gt;</span> <span class="op">(</span><span class="va">date_0</span><span class="op">-</span> <span class="fl">5</span><span class="op">*</span><span class="fl">7</span><span class="op">)</span><span class="op">]</span>,
                   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">week</span>, y <span class="op">=</span> <span class="va">q025.sim_value</span> ,colour <span class="op">=</span> <span class="st">"Credible intervall for n corrected"</span> <span class="op">)</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">nowcast_data_glm</span><span class="op">[</span><span class="va">location_code</span> <span class="op">==</span> <span class="st">"county03"</span> <span class="op">&amp;</span> <span class="va">cut_doe</span><span class="op">&gt;</span> <span class="op">(</span><span class="va">date_0</span><span class="op">-</span> <span class="fl">5</span><span class="op">*</span><span class="fl">7</span><span class="op">)</span><span class="op">]</span>,
                   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">week</span>, y <span class="op">=</span> <span class="va">q975.sim_value</span>, colour <span class="op">=</span> <span class="st">"Credible intervall for n corrected"</span> <span class="op">)</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Number of deaths"</span><span class="op">)</span> 
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>, legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">FALSE</span>, colour<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>nrow<span class="op">=</span><span class="fl">2</span>,byrow<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>
<span class="va">q</span></code></pre></div>
<p><img src="nowcast_files/figure-html/unnamed-chunk-29-1.png" width="576"></p>
<p>Finaly we can also compare the two models.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">base_line</span><span class="op">$</span><span class="va">aggregated</span><span class="op">[</span><span class="va">year</span> <span class="op">==</span> <span class="st">"2019"</span> <span class="op">&amp;</span> <span class="va">location_code</span> <span class="op">==</span> <span class="st">"county03"</span><span class="op">]</span>,
            <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">week</span>,
                y <span class="op">=</span> <span class="va">median.sim_value</span><span class="op">)</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">base_line</span><span class="op">$</span><span class="va">aggregated</span><span class="op">[</span><span class="va">year</span><span class="op">==</span> <span class="fl">2019</span> <span class="op">&amp;</span> <span class="va">location_code</span> <span class="op">==</span> <span class="st">"county03"</span><span class="op">]</span>,
                     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">week</span>, ymin<span class="op">=</span><span class="va">q025.sim_value</span>,
                         ymax<span class="op">=</span><span class="va">q975.sim_value</span>,
                         colour <span class="op">=</span> <span class="st">"Baseline estimate"</span>,
                         fill <span class="op">=</span><span class="st">"Baseline estimate"</span><span class="op">)</span>,
                     alpha<span class="op">=</span><span class="fl">0.5</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">nowcast_data_negbin</span><span class="op">[</span><span class="va">year</span> <span class="op">==</span> <span class="st">"2019"</span><span class="op">&amp;</span> <span class="va">location_code</span> <span class="op">==</span> <span class="st">"county03"</span><span class="op">]</span>,
                   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">week</span>, y <span class="op">=</span> <span class="va">ncor</span>,  
                       colour <span class="op">=</span> <span class="st">"Number of deaths corrected negbin"</span> <span class="op">)</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">nowcast_data_negbin</span><span class="op">[</span><span class="va">location_code</span> <span class="op">==</span> <span class="st">"county03"</span> <span class="op">&amp;</span> <span class="va">cut_doe</span><span class="op">&gt;</span> <span class="op">(</span><span class="va">date_0</span><span class="op">-</span> <span class="fl">5</span><span class="op">*</span><span class="fl">7</span><span class="op">)</span><span class="op">]</span>,
                   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">week</span>, y <span class="op">=</span> <span class="va">q025.sim_value</span>, 
                       colour <span class="op">=</span> <span class="st">"Credible intervall for n corrected negbin"</span> <span class="op">)</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">nowcast_data_negbin</span><span class="op">[</span><span class="va">location_code</span> <span class="op">==</span> <span class="st">"county03"</span> <span class="op">&amp;</span> <span class="va">cut_doe</span><span class="op">&gt;</span> <span class="op">(</span><span class="va">date_0</span><span class="op">-</span> <span class="fl">5</span><span class="op">*</span><span class="fl">7</span><span class="op">)</span><span class="op">]</span>,
                   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">week</span>, y <span class="op">=</span> <span class="va">q975.sim_value</span>, 
                       colour <span class="op">=</span> <span class="st">"Credible intervall for n corrected negbin"</span> <span class="op">)</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">nowcast_data_glm</span><span class="op">[</span><span class="va">year</span> <span class="op">==</span> <span class="st">"2019"</span><span class="op">&amp;</span> <span class="va">location_code</span> <span class="op">==</span> <span class="st">"county03"</span><span class="op">]</span>,
                   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">week</span>, y <span class="op">=</span> <span class="va">ncor</span>, 
                       colour <span class="op">=</span> <span class="st">"Number of deaths corrected quasipoisson"</span> <span class="op">)</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">nowcast_data_glm</span><span class="op">[</span><span class="va">location_code</span> <span class="op">==</span> <span class="st">"county03"</span> <span class="op">&amp;</span> <span class="va">cut_doe</span><span class="op">&gt;</span> <span class="op">(</span><span class="va">date_0</span><span class="op">-</span> <span class="fl">5</span><span class="op">*</span><span class="fl">7</span><span class="op">)</span><span class="op">]</span>,
                   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">week</span>, y <span class="op">=</span> <span class="va">q025.sim_value</span>,
                       colour <span class="op">=</span> <span class="st">"Credible intervall for n corrected quasipoison"</span> <span class="op">)</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">nowcast_data_glm</span><span class="op">[</span><span class="va">location_code</span> <span class="op">==</span> <span class="st">"county03"</span> <span class="op">&amp;</span> <span class="va">cut_doe</span><span class="op">&gt;</span> <span class="op">(</span><span class="va">date_0</span><span class="op">-</span> <span class="fl">5</span><span class="op">*</span><span class="fl">7</span><span class="op">)</span><span class="op">]</span>,
                   <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">week</span>, y <span class="op">=</span> <span class="va">q975.sim_value</span>, 
                       colour <span class="op">=</span> <span class="st">"Credible intervall for n corrected quasipoison"</span> <span class="op">)</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span>name <span class="op">=</span> <span class="st">"Number of deaths"</span><span class="op">)</span> 
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.position <span class="op">=</span> <span class="st">"bottom"</span>, legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guides.html">guides</a></span><span class="op">(</span>fill <span class="op">=</span> <span class="cn">FALSE</span>, colour<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/guide_legend.html">guide_legend</a></span><span class="op">(</span>nrow<span class="op">=</span><span class="fl">3</span>,byrow<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span>

<span class="va">q</span></code></pre></div>
<p><img src="nowcast_files/figure-html/unnamed-chunk-30-1.png" width="576"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Richard Aubrey White, Aurora Christine Hofman.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
