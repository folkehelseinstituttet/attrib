<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Introduction to Attrib • attrib</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Introduction to Attrib">
<meta property="og:description" content="attrib">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">attrib</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">2021.5.31</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/intro.html">Introduction to Attrib</a>
    </li>
    <li>
      <a href="../articles/nowcast.html">Nowcasting with Attrib</a>
    </li>
    <li>
      <a href="../articles/statistical_properties.html">Statistical properties used in Attrib</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/folkehelseinstituttet/attrib/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="intro_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Introduction to Attrib</h1>
                        <h4 class="author">Aurora Christine Hofman</h4>
            
            <h4 class="date">2020-07-21</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/folkehelseinstituttet/attrib/blob/master/vignettes/intro.Rmd"><code>vignettes/intro.Rmd</code></a></small>
      <div class="hidden name"><code>intro.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/folkehelseinstituttet/attrib">attrib</a></span><span class="op">)</span>
<span class="co">#&gt; attrib 2021.5.31 https://folkehelseinstituttet.github.io/attrib</span></code></pre></div>
<div id="introduction" class="section level1">
<h1 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h1>
<p><code>attrib</code> provides a way of estimating what the mortality would have been if some given exposures are set to a reference value. By using simulations from the posterior distribution of all coefficients we can easily aggregate over time and locations while still estimating valid credible intervals.</p>
<p>This vignette will go through:</p>
<ul>
<li>how to use <code>fit_attrib</code> to fit the model to the data</li>
<li>how to use <code>est_attrib</code> to estimate the mortality under different scenarios (i.e. when the exposures are at reference values and at observed values)</li>
<li>some examples of usages of the resulting dataset</li>
</ul>
<div id="data-example" class="section level2">
<h2 class="hasAnchor">
<a href="#data-example" class="anchor"></a>Data example</h2>
<p>We will use the datasets <code>fake_data_county</code> and <code>fake_data_nation</code>.</p>
<p><code>fake_data_county</code> consists of fake mortality data for all counties of Norway on a weekly basis from 2010 until 2020. The dataset consists of the following features:</p>
<ul>
<li>location_code: Location code of the different counties</li>
<li>week: Week number</li>
<li>season: Years of the season</li>
<li>year: Year</li>
<li>yrwk: Year and week</li>
<li>x: Number of weeks from the start of the season</li>
<li>pop: Population size</li>
<li>pr100_ili: Percentage of doctors consultations diagnosed with influenza like illnesses</li>
<li>pr100_ili_lag_1: pr_100_ili lagged with one week</li>
<li>temperature: Temperature</li>
<li>temperature_high: number of heatwaves</li>
<li>deaths: number of deaths</li>
</ul>
<p><code>fake_data_nation</code> is a similar dataset at the national level.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_fake_county</span> <span class="op">&lt;-</span> <span class="fu">attrib</span><span class="fu">::</span><span class="va"><a href="../reference/data_fake_county.html">data_fake_county</a></span>
<span class="va">data_fake_nation</span> <span class="op">&lt;-</span> <span class="fu">attrib</span><span class="fu">::</span><span class="va"><a href="../reference/data_fake_nation.html">data_fake_nation</a></span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">data_fake_county</span>, <span class="fl">5</span><span class="op">)</span>
<span class="co">#&gt;    location_code week    season year    yrwk  x    pop pr100_ili</span>
<span class="co">#&gt; 1:      county03    1 2009/2010 2010 2010-01 24 693494 0.5302766</span>
<span class="co">#&gt; 2:      county03    1 2010/2011 2011 2011-01 24 693494 0.7234059</span>
<span class="co">#&gt; 3:      county03    1 2011/2012 2012 2012-01 24 693494 1.7817489</span>
<span class="co">#&gt; 4:      county03    1 2012/2013 2013 2013-01 24 693494 1.6000083</span>
<span class="co">#&gt; 5:      county03    1 2013/2014 2014 2014-01 24 693494 1.6037883</span>
<span class="co">#&gt;    pr100_ili_lag_1 temperature temperature_high deaths</span>
<span class="co">#&gt; 1:       0.4496182 -0.94325234                0    103</span>
<span class="co">#&gt; 2:       0.5359123  0.01462311                0     96</span>
<span class="co">#&gt; 3:       1.8919261 -2.03893188                0    105</span>
<span class="co">#&gt; 4:       1.3909804 -6.02035548                0     97</span>
<span class="co">#&gt; 5:       1.3942666 -1.72146124                0    114</span></code></pre></div>
<p>In this example we will look at the exposures <code>pr100_ili_lag_1</code> and <code>temperature_high</code> and calculate the attributable mortality due to these exposures.</p>
</div>
</div>
<div id="fitting-using-fit_attrib" class="section level1">
<h1 class="hasAnchor">
<a href="#fitting-using-fit_attrib" class="anchor"></a>Fitting using fit_attrib</h1>
<div id="county-level" class="section level2">
<h2 class="hasAnchor">
<a href="#county-level" class="anchor"></a>County level</h2>
<p>We want to estimate the attributable mortality due to ILI and heatwaves. <code>attrib</code> lets us fit models with both fixed and random effect and offsets using linear mixed models (LMM).</p>
<p>We use the <code>glmer</code> function from the <code>lme4</code> package. In practice, this means we must specify the response, offsets, the fixed effects, and the random effects. In our case we will model the response <em>deaths</em> as a function of:</p>
<ul>
<li>the fixed effects:
<ul>
<li>temperature_high</li>
<li>pr100_ili_lag_1</li>
<li>sin(2 * pi * (week - 1) / 52)</li>
<li>cos(2 * pi * (week - 1) / 52)</li>
</ul>
</li>
<li>the random effects:
<ul>
<li>(1|location_code)</li>
<li>(pr100_ili_lag_1|season)</li>
</ul>
</li>
<li>the offset:
<ul>
<li>log(pop)</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co">#response</span>
<span class="va">response</span> <span class="op">&lt;-</span> <span class="st">"deaths"</span>

<span class="co"># fixed effects</span>
<span class="va">fixef_county</span> <span class="op">&lt;-</span> <span class="st">" temperature_high +
  pr100_ili_lag_1 +
  sin(2 * pi * (week - 1) / 52) +
  cos(2 * pi * (week - 1) / 52)"</span>


<span class="co">#random effects</span>
<span class="va">ranef_county</span> <span class="op">&lt;-</span> <span class="st">"(1|location_code) +
  (pr100_ili_lag_1|season)"</span>

<span class="co">#offset</span>
<span class="va">offset_county</span> <span class="op">&lt;-</span> <span class="st">"log(pop)"</span></code></pre></div>
<p>Now we fit the model using <code>fit_attrib</code>.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">fit_county</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_attrib.html">fit_attrib</a></span><span class="op">(</span><span class="va">data_fake_county</span>, 
                          response <span class="op">=</span> <span class="va">response</span>, 
                          fixef <span class="op">=</span> <span class="va">fixef_county</span>, 
                          ranef <span class="op">=</span> <span class="va">ranef_county</span>, 
                          offset <span class="op">=</span> <span class="va">offset_county</span><span class="op">)</span></code></pre></div>
<p>This results in the following fit:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">fit_county</span>
<span class="co">#&gt; Generalized linear mixed model fit by maximum likelihood (Laplace</span>
<span class="co">#&gt;   Approximation) [glmerMod]</span>
<span class="co">#&gt;  Family: poisson  ( log )</span>
<span class="co">#&gt; Formula: deaths ~ temperature_high + pr100_ili_lag_1 + sin(2 * pi * (week -  </span>
<span class="co">#&gt;     1)/52) + cos(2 * pi * (week - 1)/52) + offset(log(pop)) +  </span>
<span class="co">#&gt;     (1 | location_code) + (pr100_ili_lag_1 | season)</span>
<span class="co">#&gt;    Data: data</span>
<span class="co">#&gt;       AIC       BIC    logLik  deviance  df.resid </span>
<span class="co">#&gt;  44645.63  44706.39 -22313.82  44627.63      6305 </span>
<span class="co">#&gt; Random effects:</span>
<span class="co">#&gt;  Groups        Name            Std.Dev. Corr</span>
<span class="co">#&gt;  location_code (Intercept)     0.000000     </span>
<span class="co">#&gt;  season        (Intercept)     0.000000     </span>
<span class="co">#&gt;                pr100_ili_lag_1 0.004719  NaN</span>
<span class="co">#&gt; Number of obs: 6314, groups:  location_code, 11; season, 11</span>
<span class="co">#&gt; Fixed Effects:</span>
<span class="co">#&gt;                 (Intercept)             temperature_high  </span>
<span class="co">#&gt;                    -8.79616                      0.08188  </span>
<span class="co">#&gt;             pr100_ili_lag_1  sin(2 * pi * (week - 1)/52)  </span>
<span class="co">#&gt;                     0.02796                      0.01878  </span>
<span class="co">#&gt; cos(2 * pi * (week - 1)/52)  </span>
<span class="co">#&gt;                     0.07498  </span>
<span class="co">#&gt; convergence code 0; 0 optimizer warnings; 1 lme4 warnings</span></code></pre></div>
<p>Note that fit has the added attributes <code>offset</code> (saving the offset name) and <code>fit_fix</code> (the coefficients of the linear model fitted on only the fixed effects). These are needed by <code>est_attrib</code> to create the dataset containing only the fixed effects.</p>
</div>
<div id="national-level" class="section level2">
<h2 class="hasAnchor">
<a href="#national-level" class="anchor"></a>National level</h2>
<p>We estimate the same as before But on a national level, meaning we remove the random effect (1|location_code) since we only have one location code. This gives the following features:</p>
<ul>
<li>the fixed effects:
<ul>
<li>temperature_high</li>
<li>pr100_ili_lag_1</li>
<li>sin(2 * pi * (week - 1) / 52)</li>
<li>cos(2 * pi * (week - 1) / 52)</li>
</ul>
</li>
<li>the random effects:
<ul>
<li>(pr100_ili_lag_1|season)</li>
</ul>
</li>
<li>the offset:
<ul>
<li>log(pop)</li>
</ul>
</li>
</ul>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># take in the fixed effects</span>
<span class="va">response</span> <span class="op">=</span> <span class="st">"deaths"</span>
<span class="va">fixef_nation</span> <span class="op">&lt;-</span> <span class="st">"temperature_high +
  pr100_ili_lag_1 +
  sin(2 * pi * (week - 1) / 52) +
  cos(2 * pi * (week - 1) / 52)"</span>


<span class="co">#take in the random effects</span>
<span class="va">ranef_nation</span> <span class="op">&lt;-</span> <span class="st">"(pr100_ili_lag_1|season)"</span>

<span class="co"># take in the offset</span>
<span class="va">offset_nation</span> <span class="op">&lt;-</span> <span class="st">"log(pop)"</span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R">
  <span class="va">fit_nation</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_attrib.html">fit_attrib</a></span><span class="op">(</span><span class="va">data_fake_nation</span>, 
                           response <span class="op">=</span> <span class="va">response</span>, 
                           fixef <span class="op">=</span> <span class="va">fixef_nation</span>, 
                           ranef <span class="op">=</span> <span class="va">ranef_nation</span>, 
                           offset <span class="op">=</span> <span class="va">offset_nation</span><span class="op">)</span></code></pre></div>
</div>
</div>
<div id="using-the-sim-function" class="section level1">
<h1 class="hasAnchor">
<a href="#using-the-sim-function" class="anchor"></a>Using the sim function</h1>
<p>The <code>sim</code> function can be used to generate simulations for all the rows in our data.</p>
<p>It first generates <code>n_sim</code> simulations from the posterior distribution of the coefficients from out fit before applying these coefficients on our dataset generating <code>n_sim</code> simulations and expected mortality for each line. This is quite generic. Hence if the goal is to compute attributable mortality or incident risk ratios we use <code>est_attrib</code> as shown in a later part of the vignette.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">n_sim</span> <span class="op">&lt;-</span> <span class="fl">20</span>
<span class="va">sim_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/sim.html">sim</a></span><span class="op">(</span><span class="va">fit_nation</span>, <span class="va">data_fake_nation</span>, <span class="va">n_sim</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">sim_data</span><span class="op">[</span><span class="va">id_row</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span>, <span class="fl">5</span><span class="op">)</span>
<span class="co">#&gt;    week    season year    yrwk  x location_code     pop pr100_ili</span>
<span class="co">#&gt; 1:    1 2009/2010 2010 2010-01 24         norge 5367580  1.160403</span>
<span class="co">#&gt; 2:    1 2009/2010 2010 2010-01 24         norge 5367580  1.160403</span>
<span class="co">#&gt; 3:    1 2009/2010 2010 2010-01 24         norge 5367580  1.160403</span>
<span class="co">#&gt; 4:    1 2009/2010 2010 2010-01 24         norge 5367580  1.160403</span>
<span class="co">#&gt; 5:    1 2009/2010 2010 2010-01 24         norge 5367580  1.160403</span>
<span class="co">#&gt;    pr100_ili_lag_1 temperature_high deaths id_row sim_id sim_value</span>
<span class="co">#&gt; 1:        1.100072                0    891      1      1  898.9383</span>
<span class="co">#&gt; 2:        1.100072                0    891      1      2  898.3699</span>
<span class="co">#&gt; 3:        1.100072                0    891      1      3  902.2399</span>
<span class="co">#&gt; 4:        1.100072                0    891      1      4  900.0968</span>
<span class="co">#&gt; 5:        1.100072                0    891      1      5  902.4765</span></code></pre></div>
<p>We can see that we now have multiple expected mortalities for the same dataline. This is due to the coefficient simulations.</p>
</div>
<div id="estimating-attributable-mortality-using-est_attrib" class="section level1">
<h1 class="hasAnchor">
<a href="#estimating-attributable-mortality-using-est_attrib" class="anchor"></a>Estimating attributable mortality using est_attrib</h1>
<p>To estimate attributable mortality we simulate:</p>
<ul>
<li>the estimated mortality for observed exposures</li>
<li>the estimated mortality for the exposures set to reference values</li>
</ul>
<p>This is easily done using <code>est_attrib</code>.</p>
<p>We need to give the fit, the dataset, the exposures with reference values, and the number of simulations. <code>est_attrib</code> will then using the <code><a href="https://rdrr.io/pkg/arm/man/sim.html">arm::sim</a></code> function to generate simulations of the underlying posterior distribution. <code><a href="../reference/sim.html">attrib::sim</a></code> will then combine the simulated coefficients to estimate the modeled outcome (i.e. number of deaths) for each simulation.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">exposures</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span> <span class="st">"temperature_high"</span> <span class="op">=</span> <span class="fl">0</span>, <span class="st">"pr100_ili_lag_1"</span> <span class="op">=</span> <span class="fl">0</span><span class="op">)</span>
<span class="va">n_sim</span> <span class="op">&lt;-</span> <span class="fl">20</span>
<span class="va">est_attrib_sim_county</span> <span class="op">&lt;-</span> <span class="fu">attrib</span><span class="fu">::</span><span class="fu"><a href="../reference/est_attrib.html">est_attrib</a></span><span class="op">(</span><span class="va">fit_county</span>, 
                                        <span class="va">data_fake_county</span>, 
                                        exposures <span class="op">=</span> <span class="va">exposures</span>, 
                                        n_sim <span class="op">=</span> <span class="va">n_sim</span><span class="op">)</span>

<span class="va">est_attrib_sim_nation</span> <span class="op">&lt;-</span> <span class="fu">attrib</span><span class="fu">::</span><span class="fu"><a href="../reference/est_attrib.html">est_attrib</a></span><span class="op">(</span><span class="va">fit_nation</span>, 
                                        <span class="va">data_fake_nation</span>, 
                                        exposures <span class="op">=</span> <span class="va">exposures</span>,
                                        n_sim <span class="op">=</span> <span class="va">n_sim</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">est_attrib_sim_county</span>, <span class="fl">5</span><span class="op">)</span>
<span class="co">#&gt;    location_code week    season year    yrwk  x    pop pr100_ili</span>
<span class="co">#&gt; 1:      county03    1 2009/2010 2010 2010-01 24 693494 0.5302766</span>
<span class="co">#&gt; 2:      county03    1 2010/2011 2011 2011-01 24 693494 0.7234059</span>
<span class="co">#&gt; 3:      county03    1 2011/2012 2012 2012-01 24 693494 1.7817489</span>
<span class="co">#&gt; 4:      county03    1 2012/2013 2013 2013-01 24 693494 1.6000083</span>
<span class="co">#&gt; 5:      county03    1 2013/2014 2014 2014-01 24 693494 1.6037883</span>
<span class="co">#&gt;    pr100_ili_lag_1 temperature temperature_high deaths id sim_id</span>
<span class="co">#&gt; 1:       0.4496182 -0.94325234                0    103  1      1</span>
<span class="co">#&gt; 2:       0.5359123  0.01462311                0     96  2      1</span>
<span class="co">#&gt; 3:       1.8919261 -2.03893188                0    105  3      1</span>
<span class="co">#&gt; 4:       1.3909804 -6.02035548                0     97  4      1</span>
<span class="co">#&gt; 5:       1.3942666 -1.72146124                0    114  5      1</span>
<span class="co">#&gt;    sim_value_exposures=observed sim_value_temperature_high=0</span>
<span class="co">#&gt; 1:                     114.3184                     114.3184</span>
<span class="co">#&gt; 2:                     114.4157                     114.4157</span>
<span class="co">#&gt; 3:                     117.9724                     117.9724</span>
<span class="co">#&gt; 4:                     117.4144                     117.4144</span>
<span class="co">#&gt; 5:                     117.2147                     117.2147</span>
<span class="co">#&gt;    sim_value_pr100_ili_lag_1=0</span>
<span class="co">#&gt; 1:                    112.8342</span>
<span class="co">#&gt; 2:                    112.9324</span>
<span class="co">#&gt; 3:                    112.8066</span>
<span class="co">#&gt; 4:                    113.3715</span>
<span class="co">#&gt; 5:                    113.8188</span></code></pre></div>
<p>We can see in the above dataset that the columns <em>id</em>, <em>sim_id</em>, <em>sim_value_exposures=observed</em>, <em>sim_value_temperature_high=0</em>, <em>sim_value_pr100_ili_lag_1=0</em> are added to the previous set of columns. For each row in the original dataset we now have 20 <!-- change this if we change n_sim --> rows, one for each of the simulations done by est_attrib. In each row we see the estimate of the number of deaths given a reference value for <em>sim_value_temperature_high</em> and <em>sim_value_pr100_ili_lag_1</em>.</p>
<p>To make the data processing easier later we convert the dataset from wide to long form and collapse the estimated mortality</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">est_attrib_county_long</span><span class="op">&lt;-</span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/melt.data.table.html">melt.data.table</a></span><span class="op">(</span><span class="va">est_attrib_sim_county</span>, 
                                                  id.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"location_code"</span>, 
                                                              <span class="st">"season"</span>,  
                                                              <span class="st">"x"</span>, 
                                                              <span class="st">"week"</span>, 
                                                              <span class="st">"id"</span>, 
                                                              <span class="st">"sim_id"</span>, 
                                                              <span class="st">"deaths"</span>, 
                                                              <span class="st">"sim_value_exposures=observed"</span><span class="op">)</span>,
                                           measure.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sim_value_temperature_high=0"</span>, 
                                                            <span class="st">"sim_value_pr100_ili_lag_1=0"</span><span class="op">)</span><span class="op">)</span> 
<span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setattr.html">setnames</a></span><span class="op">(</span><span class="va">est_attrib_county_long</span>, <span class="st">"variable"</span>, <span class="st">"attr"</span><span class="op">)</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">est_attrib_county_long</span>, <span class="fl">5</span><span class="op">)</span>
<span class="co">#&gt;    location_code    season  x week id sim_id deaths</span>
<span class="co">#&gt; 1:      county03 2009/2010 24    1  1      1    103</span>
<span class="co">#&gt; 2:      county03 2010/2011 24    1  2      1     96</span>
<span class="co">#&gt; 3:      county03 2011/2012 24    1  3      1    105</span>
<span class="co">#&gt; 4:      county03 2012/2013 24    1  4      1     97</span>
<span class="co">#&gt; 5:      county03 2013/2014 24    1  5      1    114</span>
<span class="co">#&gt;    sim_value_exposures=observed                         attr    value</span>
<span class="co">#&gt; 1:                     114.3184 sim_value_temperature_high=0 114.3184</span>
<span class="co">#&gt; 2:                     114.4157 sim_value_temperature_high=0 114.4157</span>
<span class="co">#&gt; 3:                     117.9724 sim_value_temperature_high=0 117.9724</span>
<span class="co">#&gt; 4:                     117.4144 sim_value_temperature_high=0 117.4144</span>
<span class="co">#&gt; 5:                     117.2147 sim_value_temperature_high=0 117.2147</span></code></pre></div>
<p>We can see that the columns <em>sim_value_temperature_high=0</em>, <em>sim_value_pr100_ili_lag_1=0</em> are now collapsed into the new column <em>attr</em> and <em>value</em> with <em>attr</em> describing which exposure we have and <em>value</em> giving the corresponding reference value.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">est_attrib_nation_long</span><span class="op">&lt;-</span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/melt.data.table.html">melt.data.table</a></span><span class="op">(</span><span class="va">est_attrib_sim_nation</span>, 
                                                  id.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"location_code"</span>, 
                                                              <span class="st">"season"</span>,  
                                                              <span class="st">"x"</span>, 
                                                              <span class="st">"week"</span>, 
                                                              <span class="st">"id"</span>, 
                                                              <span class="st">"sim_id"</span>, 
                                                              <span class="st">"deaths"</span>, 
                                                              <span class="st">"sim_value_exposures=observed"</span><span class="op">)</span>,
                                           measure.vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"sim_value_temperature_high=0"</span>, 
                                                            <span class="st">"sim_value_pr100_ili_lag_1=0"</span><span class="op">)</span><span class="op">)</span> 
<span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setattr.html">setnames</a></span><span class="op">(</span><span class="va">est_attrib_nation_long</span>, <span class="st">"variable"</span>, <span class="st">"attr"</span><span class="op">)</span></code></pre></div>
</div>
<div id="compare-the-national-data-to-data-aggregated-from-county-to-national-level-" class="section level1">
<h1 class="hasAnchor">
<a href="#compare-the-national-data-to-data-aggregated-from-county-to-national-level-" class="anchor"></a>Compare the national data to data aggregated from county to national level.</h1>
<p>We will now aggregate our two simulated datasets (one on a county level and one on a national level) to aid in comparison.</p>
<div id="aggregate-from-countyweekly-to-nationalseasonal" class="section level2">
<h2 class="hasAnchor">
<a href="#aggregate-from-countyweekly-to-nationalseasonal" class="anchor"></a>Aggregate from county/weekly to national/seasonal</h2>
<p>We proceed by aggregating the county dataset to the national/seasonal level. Afterwards we calculate the expected attributable mortality, <code>exp_attr</code>, by subtracting <code>value</code> (the simulated expected number of deaths given the reference value of the exposure) from <em>the sim_value_exposures=observed</em>.</p>
<p>To be able to separate this dataset from the other we add a tag.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">aggregated_county_to_nation</span> <span class="op">&lt;-</span>  <span class="va">est_attrib_county_long</span><span class="op">[</span>,<span class="fu">.</span><span class="op">(</span>
  <span class="st">"sim_value_exposures=observed"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">`sim_value_exposures=observed`</span><span class="op">)</span>,
  value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, 
  deaths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">deaths</span><span class="op">)</span>
<span class="op">)</span>, keyby <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">season</span>, <span class="va">attr</span>, <span class="va">sim_id</span><span class="op">)</span><span class="op">]</span>

<span class="co"># Add exp_attr, exp_irr and a tag.</span>
<span class="va">aggregated_county_to_nation</span><span class="op">[</span>, <span class="va">exp_attr</span><span class="op">:=</span> <span class="op">(</span><span class="va">`sim_value_exposures=observed`</span> <span class="op">-</span> <span class="va">value</span><span class="op">)</span><span class="op">]</span>
<span class="va">aggregated_county_to_nation</span><span class="op">[</span>, <span class="va">tag</span> <span class="op">:=</span> <span class="st">"aggregated_from_county"</span><span class="op">]</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">aggregated_county_to_nation</span>, <span class="fl">5</span><span class="op">)</span>
<span class="co">#&gt;       season                         attr sim_id sim_value_exposures=observed</span>
<span class="co">#&gt; 1: 2009/2010 sim_value_temperature_high=0      1                     44022.12</span>
<span class="co">#&gt; 2: 2009/2010 sim_value_temperature_high=0      2                     44180.05</span>
<span class="co">#&gt; 3: 2009/2010 sim_value_temperature_high=0      3                     44431.52</span>
<span class="co">#&gt; 4: 2009/2010 sim_value_temperature_high=0      4                     44223.51</span>
<span class="co">#&gt; 5: 2009/2010 sim_value_temperature_high=0      5                     44253.04</span>
<span class="co">#&gt;       value deaths exp_attr                    tag</span>
<span class="co">#&gt; 1: 43632.11  44421 390.0096 aggregated_from_county</span>
<span class="co">#&gt; 2: 43766.90  44421 413.1427 aggregated_from_county</span>
<span class="co">#&gt; 3: 44025.72  44421 405.8018 aggregated_from_county</span>
<span class="co">#&gt; 4: 43798.08  44421 425.4291 aggregated_from_county</span>
<span class="co">#&gt; 5: 43834.21  44421 418.8302 aggregated_from_county</span></code></pre></div>
</div>
<div id="aggregating-the-national-model-per-season" class="section level2">
<h2 class="hasAnchor">
<a href="#aggregating-the-national-model-per-season" class="anchor"></a>Aggregating the national model per season</h2>
<p>For the national model we aggregate over seasons and create exp_attr in the same way as above.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">aggregated_nation</span> <span class="op">&lt;-</span>  <span class="va">est_attrib_nation_long</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>
  <span class="st">"sim_value_exposures=observed"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">`sim_value_exposures=observed`</span><span class="op">)</span>,
  value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, 
  deaths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">deaths</span><span class="op">)</span>
<span class="op">)</span>, keyby <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">season</span>, <span class="va">attr</span>, <span class="va">sim_id</span><span class="op">)</span><span class="op">]</span>

<span class="va">aggregated_nation</span><span class="op">[</span>, <span class="va">exp_attr</span><span class="op">:=</span> <span class="op">(</span><span class="va">`sim_value_exposures=observed`</span> <span class="op">-</span> <span class="va">value</span><span class="op">)</span><span class="op">]</span>
<span class="va">aggregated_nation</span><span class="op">[</span>, <span class="va">tag</span><span class="op">:=</span> <span class="st">"nation"</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">aggregated_nation</span>, <span class="fl">5</span><span class="op">)</span>
<span class="co">#&gt;       season                         attr sim_id sim_value_exposures=observed</span>
<span class="co">#&gt; 1: 2009/2010 sim_value_temperature_high=0      1                     44611.88</span>
<span class="co">#&gt; 2: 2009/2010 sim_value_temperature_high=0      2                     44136.06</span>
<span class="co">#&gt; 3: 2009/2010 sim_value_temperature_high=0      3                     44396.20</span>
<span class="co">#&gt; 4: 2009/2010 sim_value_temperature_high=0      4                     44369.27</span>
<span class="co">#&gt; 5: 2009/2010 sim_value_temperature_high=0      5                     44503.27</span>
<span class="co">#&gt;       value deaths exp_attr    tag</span>
<span class="co">#&gt; 1: 44611.88  44421        0 nation</span>
<span class="co">#&gt; 2: 44136.06  44421        0 nation</span>
<span class="co">#&gt; 3: 44396.20  44421        0 nation</span>
<span class="co">#&gt; 4: 44369.27  44421        0 nation</span>
<span class="co">#&gt; 5: 44503.27  44421        0 nation</span></code></pre></div>
<p>For simplicity we <code><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">data.table::rbindlist</a></code> the two datasets together.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="va">data_national</span><span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">aggregated_county_to_nation</span>, <span class="va">aggregated_nation</span><span class="op">)</span><span class="op">)</span></code></pre></div>
</div>
<div id="calculate-simulation-quantiles-" class="section level2">
<h2 class="hasAnchor">
<a href="#calculate-simulation-quantiles-" class="anchor"></a>Calculate simulation quantiles.</h2>
<p>The next thing to do is to aggregate away the simulations. The benefits of having the simulations is the possibility it gives to efficiently compute all desired quantiles. For this example we will use the .05, .5 and .95 quantiles.</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># Quantile functins</span>
<span class="va">q025</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0.025</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span>
<span class="va">q975</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">{</span>
  <span class="kw"><a href="https://rdrr.io/r/base/function.html">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span><span class="op">(</span><span class="va">x</span>, <span class="fl">0.975</span><span class="op">)</span><span class="op">)</span>
<span class="op">}</span></code></pre></div>
<p>We compute the quantiles for <em>exp_attr</em> in the following way.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">col_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">data_national</span><span class="op">)</span>
<span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setkey.html">setkeyv</a></span><span class="op">(</span><span class="va">data_national</span>, 
                    <span class="va">col_names</span><span class="op">[</span><span class="op">!</span><span class="va">col_names</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"exp_attr"</span>, 
                                                <span class="st">"sim_id"</span>, 
                                                <span class="st">"sim_value_exposures=observed"</span>, 
                                                <span class="st">"value"</span>, 
                                                <span class="st">"deaths"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>

<span class="va">aggregated_sim_seasonal_data_national</span><span class="op">&lt;-</span> <span class="va">data_national</span><span class="op">[</span>,
                                   <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span>recursive <span class="op">=</span> <span class="cn">FALSE</span>, 
                                          <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu">.</span><span class="op">(</span>median <span class="op">=</span> <span class="va">median</span>, q025 <span class="op">=</span> <span class="va">q025</span>, q975 <span class="op">=</span> <span class="va">q975</span><span class="op">)</span>,
                                                                    <span class="kw">function</span><span class="op">(</span><span class="va">f</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">f</span><span class="op">)</span>
                                   <span class="op">)</span><span class="op">)</span>, 
                                   by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span><span class="op">(</span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setkey.html">key</a></span><span class="op">(</span><span class="va">data_national</span><span class="op">)</span><span class="op">)</span>,
                                   .SDcols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"exp_attr"</span><span class="op">)</span><span class="op">]</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">aggregated_sim_seasonal_data_national</span>,<span class="fl">5</span><span class="op">)</span>
<span class="co">#&gt;       season                         attr                    tag</span>
<span class="co">#&gt; 1: 2009/2010 sim_value_temperature_high=0 aggregated_from_county</span>
<span class="co">#&gt; 2: 2009/2010 sim_value_temperature_high=0                 nation</span>
<span class="co">#&gt; 3: 2009/2010  sim_value_pr100_ili_lag_1=0 aggregated_from_county</span>
<span class="co">#&gt; 4: 2009/2010  sim_value_pr100_ili_lag_1=0                 nation</span>
<span class="co">#&gt; 5: 2010/2011 sim_value_temperature_high=0 aggregated_from_county</span>
<span class="co">#&gt;    median.exp_attr q025.exp_attr q975.exp_attr</span>
<span class="co">#&gt; 1:        419.0386      397.3456      434.8880</span>
<span class="co">#&gt; 2:          0.0000        0.0000        0.0000</span>
<span class="co">#&gt; 3:        657.2968      549.6016      851.7482</span>
<span class="co">#&gt; 4:       1135.4843      921.6938     1306.8053</span>
<span class="co">#&gt; 5:        445.5863      420.0875      459.4223</span></code></pre></div>
<p>We can now see that we have credible intervals and estimates for attributable deaths for all exposures.</p>
</div>
<div id="plot-to-compare-the-national-with-the-aggregated-county-to-national-model" class="section level2">
<h2 class="hasAnchor">
<a href="#plot-to-compare-the-national-with-the-aggregated-county-to-national-model" class="anchor"></a>Plot to compare the national with the aggregated county to national model</h2>
<p>To be able to compare the two models we make a point range plot using ggplot2.</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">aggregated_sim_seasonal_data_national</span><span class="op">[</span><span class="va">attr</span> <span class="op">==</span> <span class="st">"sim_value_pr100_ili_lag_1=0"</span><span class="op">]</span>, 
                       <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">season</span>, y <span class="op">=</span> <span class="va">median.exp_attr</span>, group <span class="op">=</span> <span class="va">tag</span>, color <span class="op">=</span> <span class="va">tag</span><span class="op">)</span><span class="op">)</span> 
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_pointrange</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">season</span>, y <span class="op">=</span> <span class="va">median.exp_attr</span>, ymin <span class="op">=</span> <span class="va">q025.exp_attr</span>, ymax <span class="op">=</span> <span class="va">q975.exp_attr</span><span class="op">)</span>, position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Attributable mortality due to ILI in Norway according to 2 models"</span><span class="op">)</span> 
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span><span class="st">"Estimated attributable mortality"</span><span class="op">)</span> 
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span><span class="op">)</span>,axis.title.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> 
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>caption <span class="op">=</span> <span class="fu">glue</span><span class="fu">::</span><span class="fu"><a href="https://glue.tidyverse.org/reference/glue.html">glue</a></span><span class="op">(</span><span class="st">"Aggregated county model: Attributable mortality modeled on a county level before beeing aggregated up to a national level.\n National model: Attributable mortality modeled on a national level."</span><span class="op">)</span><span class="op">)</span>
<span class="va">q</span></code></pre></div>
<p><img src="intro_files/figure-html/unnamed-chunk-17-1.png" width="576"></p>
</div>
</div>
<div id="comparing-cumulative-sums-over-seasons" class="section level1">
<h1 class="hasAnchor">
<a href="#comparing-cumulative-sums-over-seasons" class="anchor"></a>Comparing cumulative sums over seasons</h1>
<p>When operating on the national level, we prefer to aggregate the county model to national level (instead of using the national model). This ensures consistent results at all geographical levels.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">aggregated_county_to_nation</span> <span class="op">&lt;-</span>  <span class="va">est_attrib_county_long</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>
  <span class="st">"sim_value_exposures=observed"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">`sim_value_exposures=observed`</span><span class="op">)</span>,
  value <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">value</span><span class="op">)</span>, 
  deaths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">deaths</span><span class="op">)</span>
<span class="op">)</span>, keyby <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">season</span>, <span class="va">x</span>, <span class="va">week</span>, <span class="va">attr</span>, <span class="va">sim_id</span><span class="op">)</span><span class="op">]</span>

<span class="va">aggregated_county_to_nation</span><span class="op">[</span>, <span class="va">exp_attr</span><span class="op">:=</span> <span class="op">(</span><span class="va">`sim_value_exposures=observed`</span> <span class="op">-</span> <span class="va">value</span><span class="op">)</span><span class="op">]</span>
<span class="va">aggregated_county_to_nation</span><span class="op">[</span>, <span class="va">exp_irr</span><span class="op">:=</span> <span class="op">(</span><span class="va">`sim_value_exposures=observed`</span> <span class="op">/</span><span class="va">value</span><span class="op">)</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">aggregated_county_to_nation</span>,<span class="fl">5</span><span class="op">)</span>
<span class="co">#&gt;       season x week                         attr sim_id</span>
<span class="co">#&gt; 1: 2009/2010 1   30 sim_value_temperature_high=0      1</span>
<span class="co">#&gt; 2: 2009/2010 1   30 sim_value_temperature_high=0      2</span>
<span class="co">#&gt; 3: 2009/2010 1   30 sim_value_temperature_high=0      3</span>
<span class="co">#&gt; 4: 2009/2010 1   30 sim_value_temperature_high=0      4</span>
<span class="co">#&gt; 5: 2009/2010 1   30 sim_value_temperature_high=0      5</span>
<span class="co">#&gt;    sim_value_exposures=observed    value deaths exp_attr  exp_irr</span>
<span class="co">#&gt; 1:                     783.0098 747.7373    816 35.27247 1.047172</span>
<span class="co">#&gt; 2:                     786.8947 749.5351    816 37.35957 1.049844</span>
<span class="co">#&gt; 3:                     789.9572 753.2515    816 36.70575 1.048730</span>
<span class="co">#&gt; 4:                     787.8798 749.4184    816 38.46144 1.051322</span>
<span class="co">#&gt; 5:                     789.1113 751.2394    816 37.87190 1.050413</span></code></pre></div>
<p>Again we compute the quantiles.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">col_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">aggregated_county_to_nation</span><span class="op">)</span>
<span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setkey.html">setkeyv</a></span><span class="op">(</span><span class="va">aggregated_county_to_nation</span>, <span class="va">col_names</span><span class="op">[</span><span class="op">!</span><span class="va">col_names</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"exp_attr"</span>, <span class="st">"exp_irr"</span>,<span class="st">"sim_id"</span>, <span class="st">"exposures"</span>, <span class="st">"sim_value_exposures=observed"</span>, <span class="st">"value"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>

<span class="va">aggregated_county_to_nation_weekly</span> <span class="op">&lt;-</span> <span class="va">aggregated_county_to_nation</span><span class="op">[</span>,
              <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span>recursive <span class="op">=</span> <span class="cn">FALSE</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu">.</span><span class="op">(</span>median <span class="op">=</span> <span class="va">median</span>, q025 <span class="op">=</span> <span class="va">q025</span>, q975 <span class="op">=</span> <span class="va">q975</span><span class="op">)</span>,
                                               <span class="kw">function</span><span class="op">(</span><span class="va">f</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">f</span><span class="op">)</span>
              <span class="op">)</span><span class="op">)</span>, 
              by<span class="op">=</span><span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span><span class="op">(</span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setkey.html">key</a></span><span class="op">(</span><span class="va">aggregated_county_to_nation</span><span class="op">)</span><span class="op">)</span>,
              .SDcols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"exp_attr"</span>, <span class="st">"exp_irr"</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<p>We then estimate the cumulative sums of attributable mortality and corresponding credible intervals.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">aggregated_county_to_nation_weekly</span><span class="op">[</span>, <span class="va">cumsum</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">median.exp_attr</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span> <span class="va">attr</span>, <span class="va">season</span><span class="op">)</span><span class="op">]</span>
<span class="va">aggregated_county_to_nation_weekly</span><span class="op">[</span>, <span class="va">cumsum_q025</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">q025.exp_attr</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span> <span class="va">attr</span>, <span class="va">season</span><span class="op">)</span><span class="op">]</span>
<span class="va">aggregated_county_to_nation_weekly</span><span class="op">[</span>, <span class="va">cumsum_q975</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/cumsum.html">cumsum</a></span><span class="op">(</span><span class="va">q975.exp_attr</span><span class="op">)</span>, by <span class="op">=</span> <span class="fu">.</span><span class="op">(</span> <span class="va">attr</span>, <span class="va">season</span><span class="op">)</span><span class="op">]</span>

<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">aggregated_county_to_nation_weekly</span>, <span class="fl">5</span><span class="op">)</span>
<span class="co">#&gt;       season x week                         attr deaths median.exp_attr</span>
<span class="co">#&gt; 1: 2009/2010 1   30 sim_value_temperature_high=0    816    37.899369839</span>
<span class="co">#&gt; 2: 2009/2010 1   30  sim_value_pr100_ili_lag_1=0    816     0.000000000</span>
<span class="co">#&gt; 3: 2009/2010 2   31 sim_value_temperature_high=0    854    81.101046320</span>
<span class="co">#&gt; 4: 2009/2010 2   31  sim_value_pr100_ili_lag_1=0    854     0.002099496</span>
<span class="co">#&gt; 5: 2009/2010 3   32 sim_value_temperature_high=0    777    45.544723132</span>
<span class="co">#&gt;    median.exp_irr q025.exp_attr q025.exp_irr q975.exp_attr q975.exp_irr</span>
<span class="co">#&gt; 1:       1.050656  35.937402626     1.047912  39.327257332     1.052412</span>
<span class="co">#&gt; 2:       1.000000   0.000000000     1.000000   0.000000000     1.000000</span>
<span class="co">#&gt; 3:       1.108198  76.861682877     1.102287  84.170593217     1.111983</span>
<span class="co">#&gt; 4:       1.000003   0.001758019     1.000002   0.002726861     1.000003</span>
<span class="co">#&gt; 5:       1.060578  43.176709354     1.057295  47.248500376     1.062679</span>
<span class="co">#&gt;          cumsum  cumsum_q025  cumsum_q975</span>
<span class="co">#&gt; 1: 3.789937e+01 3.593740e+01 3.932726e+01</span>
<span class="co">#&gt; 2: 0.000000e+00 0.000000e+00 0.000000e+00</span>
<span class="co">#&gt; 3: 1.190004e+02 1.127991e+02 1.234979e+02</span>
<span class="co">#&gt; 4: 2.099496e-03 1.758019e-03 2.726861e-03</span>
<span class="co">#&gt; 5: 1.645451e+02 1.559758e+02 1.707464e+02</span></code></pre></div>
<p>We can then plot the estimated cumulative attributable mortality over influenza seasons in Norway</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">aggregated_county_to_nation_weekly</span><span class="op">[</span>
    <span class="va">season</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="st">"2015/2016"</span>,
      <span class="st">"2016/2017"</span>,
      <span class="st">"2017/2018"</span>,
      <span class="st">"2018/2019"</span>,
      <span class="st">"2019/2020"</span>
    <span class="op">)</span> <span class="op">&amp;</span>
    <span class="va">attr</span> <span class="op">==</span> <span class="st">"sim_value_pr100_ili_lag_1=0"</span>
  <span class="op">]</span>,
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>
    x <span class="op">=</span> <span class="va">x</span>, 
    y <span class="op">=</span> <span class="va">cumsum</span>, 
    group <span class="op">=</span> <span class="va">season</span>, 
    color <span class="op">=</span> <span class="va">season</span>, 
    fill <span class="op">=</span> <span class="va">season</span>
  <span class="op">)</span>
<span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">aggregated_county_to_nation_weekly</span><span class="op">[</span>
    <span class="va">season</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2019/2020"</span><span class="op">)</span> <span class="op">&amp;</span>
    <span class="va">attr</span> <span class="op">==</span> <span class="st">"sim_value_pr100_ili_lag_1=0"</span>
  <span class="op">]</span>,
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>
    ymin <span class="op">=</span> <span class="va">cumsum_q025</span>, 
    ymax <span class="op">=</span> <span class="va">cumsum_q975</span>
  <span class="op">)</span>, 
  alpha <span class="op">=</span> <span class="fl">0.4</span>, 
  colour <span class="op">=</span> <span class="cn">NA</span>
<span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span><span class="st">"Estimated cumulative attributable mortality"</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Estimated cumulative attributable mortality over influenza seasons in Norway"</span><span class="op">)</span>
<span class="va">q</span></code></pre></div>
<p><img src="intro_files/figure-html/unnamed-chunk-21-1.png" width="576"></p>
<p>We can also plot the estimated weekly attributable mortality in Norway</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">aggregated_county_to_nation_weekly</span><span class="op">[</span><span class="va">attr</span> <span class="op">==</span> <span class="st">"sim_value_pr100_ili_lag_1=0"</span><span class="op">]</span>, 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">x</span>, y <span class="op">=</span> <span class="va">cumsum</span>, group <span class="op">=</span> <span class="va">season</span><span class="op">)</span>
  <span class="op">)</span> 
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">aggregated_county_to_nation_weekly</span><span class="op">[</span>
    <span class="va">season</span> <span class="op">!=</span> <span class="st">"2019/2020"</span> <span class="op">&amp;</span>
    <span class="va">attr</span> <span class="op">==</span> <span class="st">"sim_value_pr100_ili_lag_1=0"</span>
  <span class="op">]</span>,
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>
    x <span class="op">=</span> <span class="va">x</span>, 
    y <span class="op">=</span> <span class="va">median.exp_attr</span>, 
    group <span class="op">=</span> <span class="va">season</span>
  <span class="op">)</span>, 
  color <span class="op">=</span> <span class="st">"grey"</span>
<span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">aggregated_county_to_nation_weekly</span><span class="op">[</span>
    <span class="va">season</span> <span class="op">==</span> <span class="st">"2019/2020"</span> <span class="op">&amp;</span>
    <span class="va">attr</span> <span class="op">==</span> <span class="st">"sim_value_pr100_ili_lag_1=0"</span>
  <span class="op">]</span>, 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>
    x <span class="op">=</span> <span class="va">x</span>,
    y <span class="op">=</span> <span class="va">median.exp_attr</span>,
    group <span class="op">=</span> <span class="va">season</span>
  <span class="op">)</span>, 
  color <span class="op">=</span> <span class="st">"blue"</span>
<span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">aggregated_county_to_nation_weekly</span><span class="op">[</span>
    <span class="va">season</span> <span class="op">==</span> <span class="st">"2019/2020"</span> <span class="op">&amp;</span>
    <span class="va">attr</span> <span class="op">==</span> <span class="st">"sim_value_pr100_ili_lag_1=0"</span>
  <span class="op">]</span>,
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>
    x <span class="op">=</span> <span class="va">x</span>,
    ymin <span class="op">=</span> <span class="va">q025.exp_attr</span>,
    ymax <span class="op">=</span> <span class="va">q975.exp_attr</span>
  <span class="op">)</span>,
  fill <span class="op">=</span> <span class="st">"blue"</span>,
  alpha<span class="op">=</span><span class="fl">0.4</span>
<span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html">scale_y_continuous</a></span><span class="op">(</span><span class="st">"Estimated attributable mortality"</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Estimated mortality due to ILI per week"</span><span class="op">)</span>
<span class="va">q</span></code></pre></div>
<p><img src="intro_files/figure-html/unnamed-chunk-22-1.png" width="700"></p>
</div>
<div id="incident-rate-ratio" class="section level1">
<h1 class="hasAnchor">
<a href="#incident-rate-ratio" class="anchor"></a>Incident rate ratio</h1>
<p>Until now we have focused on estimating attributable mortality. Now we will investigate computing the incident rate ratio (IRR) for <em>pr100_ili_lag_1</em>. To do this we will use the fit made by <code>fit_attrib</code> on the county dataset but we will change the values for <em>pr100_ili_lag_1</em> to 1 (IRRs are generally expressed as the effect of the exposure changing from 0 to 1).</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">data_fake_county_irr</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/copy.html">copy</a></span><span class="op">(</span><span class="va">data_fake_county</span><span class="op">)</span>
<span class="va">data_fake_county_irr</span><span class="op">[</span>, <span class="va">pr100_ili_lag_1</span> <span class="op">:=</span> <span class="fl">1</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">data_fake_county_irr</span>, <span class="fl">5</span><span class="op">)</span>
<span class="co">#&gt;    location_code week    season year    yrwk  x    pop pr100_ili</span>
<span class="co">#&gt; 1:      county03    1 2009/2010 2010 2010-01 24 693494 0.5302766</span>
<span class="co">#&gt; 2:      county03    1 2010/2011 2011 2011-01 24 693494 0.7234059</span>
<span class="co">#&gt; 3:      county03    1 2011/2012 2012 2012-01 24 693494 1.7817489</span>
<span class="co">#&gt; 4:      county03    1 2012/2013 2013 2013-01 24 693494 1.6000083</span>
<span class="co">#&gt; 5:      county03    1 2013/2014 2014 2014-01 24 693494 1.6037883</span>
<span class="co">#&gt;    pr100_ili_lag_1 temperature temperature_high deaths</span>
<span class="co">#&gt; 1:               1 -0.94325234                0    103</span>
<span class="co">#&gt; 2:               1  0.01462311                0     96</span>
<span class="co">#&gt; 3:               1 -2.03893188                0    105</span>
<span class="co">#&gt; 4:               1 -6.02035548                0     97</span>
<span class="co">#&gt; 5:               1 -1.72146124                0    114</span></code></pre></div>
<p>Then we can set the reference value to zero and hence obtain the IRR for the given exposure.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">exposures_irr</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>pr100_ili_lag_1 <span class="op">=</span> <span class="fl">0</span><span class="op">)</span></code></pre></div>
<p>Now we use <code>est_attrib</code> to create the simulations.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">est_attrib_sim_county_irr</span> <span class="op">&lt;-</span> <span class="fu">attrib</span><span class="fu">::</span><span class="fu"><a href="../reference/est_attrib.html">est_attrib</a></span><span class="op">(</span>
  <span class="va">fit_county</span>, 
  <span class="va">data_fake_county_irr</span>, 
  exposures <span class="op">=</span> <span class="va">exposures_irr</span>,
  n_sim <span class="op">=</span> <span class="fl">100</span>
<span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">est_attrib_sim_county_irr</span>, <span class="fl">5</span><span class="op">)</span>
<span class="co">#&gt;    location_code week    season year    yrwk  x    pop pr100_ili</span>
<span class="co">#&gt; 1:      county03    1 2009/2010 2010 2010-01 24 693494 0.5302766</span>
<span class="co">#&gt; 2:      county03    1 2010/2011 2011 2011-01 24 693494 0.7234059</span>
<span class="co">#&gt; 3:      county03    1 2011/2012 2012 2012-01 24 693494 1.7817489</span>
<span class="co">#&gt; 4:      county03    1 2012/2013 2013 2013-01 24 693494 1.6000083</span>
<span class="co">#&gt; 5:      county03    1 2013/2014 2014 2014-01 24 693494 1.6037883</span>
<span class="co">#&gt;    pr100_ili_lag_1 temperature temperature_high deaths id sim_id</span>
<span class="co">#&gt; 1:               1 -0.94325234                0    103  1      1</span>
<span class="co">#&gt; 2:               1  0.01462311                0     96  2      1</span>
<span class="co">#&gt; 3:               1 -2.03893188                0    105  3      1</span>
<span class="co">#&gt; 4:               1 -6.02035548                0     97  4      1</span>
<span class="co">#&gt; 5:               1 -1.72146124                0    114  5      1</span>
<span class="co">#&gt;    sim_value_exposures=observed sim_value_pr100_ili_lag_1=0</span>
<span class="co">#&gt; 1:                     116.6158                    112.7674</span>
<span class="co">#&gt; 2:                     115.7253                    112.3890</span>
<span class="co">#&gt; 3:                     115.2659                    111.9929</span>
<span class="co">#&gt; 4:                     116.4736                    113.0416</span>
<span class="co">#&gt; 5:                     115.1344                    112.0634</span></code></pre></div>
<p>We see we have obtained values for the reference of the exposure in the same way as before. The difference is that we changed the dataset before running <em>est_attrib</em>. This means we will now be observing the difference between <code>pr100_ili_lag_1=0</code> and <code>pr100_ili_lag_1=1</code>.</p>
<p>We now aggregate to the national seasonal level.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">aggregated_county_to_nation_sim_irr</span> <span class="op">&lt;-</span>  <span class="va">est_attrib_sim_county_irr</span><span class="op">[</span>, <span class="fu">.</span><span class="op">(</span>
  <span class="st">"sim_value_exposures=observed"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">`sim_value_exposures=observed`</span><span class="op">)</span>,
  <span class="st">"sim_value_pr100_ili_lag_1=0"</span><span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">`sim_value_pr100_ili_lag_1=0`</span><span class="op">)</span>, 
  deaths <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html">sum</a></span><span class="op">(</span><span class="va">deaths</span><span class="op">)</span>
<span class="op">)</span>, keyby <span class="op">=</span> <span class="fu">.</span><span class="op">(</span><span class="va">season</span>, <span class="va">sim_id</span><span class="op">)</span><span class="op">]</span></code></pre></div>
<p>Here we generate the IRR:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">aggregated_county_to_nation_sim_irr</span><span class="op">[</span>, <span class="va">exp_irr</span><span class="op">:=</span> <span class="op">(</span><span class="va">`sim_value_exposures=observed`</span><span class="op">/</span><span class="va">`sim_value_pr100_ili_lag_1=0`</span>
<span class="op">)</span><span class="op">]</span>
<span class="fu"><a href="https://rdrr.io/r/utils/head.html">head</a></span><span class="op">(</span><span class="va">aggregated_county_to_nation_sim_irr</span>,<span class="fl">5</span><span class="op">)</span>
<span class="co">#&gt;       season sim_id sim_value_exposures=observed sim_value_pr100_ili_lag_1=0</span>
<span class="co">#&gt; 1: 2009/2010      1                     45067.96                    43580.70</span>
<span class="co">#&gt; 2: 2009/2010      2                     45011.17                    43530.99</span>
<span class="co">#&gt; 3: 2009/2010      3                     45235.52                    43950.25</span>
<span class="co">#&gt; 4: 2009/2010      4                     45090.42                    43532.32</span>
<span class="co">#&gt; 5: 2009/2010      5                     45182.80                    43939.54</span>
<span class="co">#&gt;    deaths  exp_irr</span>
<span class="co">#&gt; 1:  44421 1.034127</span>
<span class="co">#&gt; 2:  44421 1.034003</span>
<span class="co">#&gt; 3:  44421 1.029244</span>
<span class="co">#&gt; 4:  44421 1.035792</span>
<span class="co">#&gt; 5:  44421 1.028295</span></code></pre></div>
<p>Now we can compute the quantiles:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="va">col_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html">colnames</a></span><span class="op">(</span><span class="va">aggregated_county_to_nation_sim_irr</span><span class="op">)</span>
<span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setkey.html">setkeyv</a></span><span class="op">(</span>
  <span class="va">aggregated_county_to_nation_sim_irr</span>,
  <span class="va">col_names</span><span class="op">[</span><span class="op">!</span><span class="va">col_names</span> <span class="op">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"exp_irr"</span>, <span class="st">"sim_id"</span>, <span class="st">"sim_value_exposures=observed"</span>, <span class="st">"sim_value_pr100_ili_lag_1=0"</span><span class="op">)</span><span class="op">]</span>
<span class="op">)</span>

<span class="va">aggregated_county_to_nation_irr</span> <span class="op">&lt;-</span> <span class="va">aggregated_county_to_nation_sim_irr</span><span class="op">[</span>,
  <span class="fu"><a href="https://rdrr.io/r/base/unlist.html">unlist</a></span><span class="op">(</span>recursive <span class="op">=</span> <span class="cn">FALSE</span>, <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="fu">.</span><span class="op">(</span>median <span class="op">=</span> <span class="va">median</span>, q025 <span class="op">=</span> <span class="va">q025</span>, q975 <span class="op">=</span> <span class="va">q975</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">f</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">.SD</span>, <span class="va">f</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,
  by <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/eval.html">eval</a></span><span class="op">(</span><span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/setkey.html">key</a></span><span class="op">(</span><span class="va">aggregated_county_to_nation_sim_irr</span><span class="op">)</span><span class="op">)</span>,
  .SDcols <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"exp_irr"</span><span class="op">)</span>
<span class="op">]</span>
<span class="va">aggregated_county_to_nation_irr</span><span class="op">[</span>, <span class="va">tag</span> <span class="op">:=</span> <span class="st">"aggregated"</span><span class="op">]</span>

<span class="va">aggregated_county_to_nation_irr</span>
<span class="co">#&gt;        season deaths median.exp_irr q025.exp_irr q975.exp_irr        tag</span>
<span class="co">#&gt;  1: 2009/2010  44421       1.032471     1.023866     1.039481 aggregated</span>
<span class="co">#&gt;  2: 2010/2011  43062       1.027621     1.019369     1.035196 aggregated</span>
<span class="co">#&gt;  3: 2011/2012  43431       1.026856     1.018481     1.034855 aggregated</span>
<span class="co">#&gt;  4: 2012/2013  43228       1.028740     1.020524     1.036421 aggregated</span>
<span class="co">#&gt;  5: 2013/2014  43328       1.024961     1.016490     1.033019 aggregated</span>
<span class="co">#&gt;  6: 2014/2015  42951       1.027158     1.019107     1.035644 aggregated</span>
<span class="co">#&gt;  7: 2015/2016  43736       1.022271     1.014079     1.030135 aggregated</span>
<span class="co">#&gt;  8: 2016/2017  43821       1.032681     1.024168     1.041026 aggregated</span>
<span class="co">#&gt;  9: 2017/2018  43716       1.031172     1.022759     1.038742 aggregated</span>
<span class="co">#&gt; 10: 2018/2019  43326       1.026409     1.018225     1.034455 aggregated</span>
<span class="co">#&gt; 11: 2019/2020  43572       1.029899     1.021808     1.038152 aggregated</span></code></pre></div>
<p>Now we compare the resulting values for IRR with the ones obtained by <code>coef(fit_county)$season</code> and the 90 percent credible interval computed manually using the standard deviation given by summary(fit_county) for <em>pr100_ili_lag_1</em>.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">coef_fit_county</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/as.data.table.html">as.data.table</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html">coef</a></span><span class="op">(</span><span class="va">fit_county</span><span class="op">)</span><span class="op">$</span><span class="va">season</span><span class="op">)</span>
<span class="va">col_names_coef</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"pr100_ili_lag_1"</span><span class="op">)</span>
<span class="va">coef_irr_data</span> <span class="op">&lt;-</span> <span class="va">coef_fit_county</span><span class="op">[</span>, <span class="va">..col_names_coef</span><span class="op">]</span>
<span class="va">coef_irr_data</span><span class="op">[</span>, <span class="va">irr</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">pr100_ili_lag_1</span><span class="op">)</span><span class="op">]</span>
<span class="va">coef_irr_data</span><span class="op">[</span>, <span class="va">q025</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">pr100_ili_lag_1</span> <span class="op">-</span> <span class="fl">1.96</span> <span class="op">*</span><span class="fl">0.003761</span><span class="op">)</span><span class="op">]</span>  <span class="co"># 0.003761 is the standard deviation from coef(fit_county)</span>
<span class="va">coef_irr_data</span><span class="op">[</span>, <span class="va">q975</span> <span class="op">:=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">exp</a></span><span class="op">(</span><span class="va">pr100_ili_lag_1</span> <span class="op">+</span> <span class="fl">1.96</span> <span class="op">*</span><span class="fl">0.003761</span><span class="op">)</span><span class="op">]</span>
<span class="va">coef_irr_data</span><span class="op">[</span>, <span class="va">tag</span> <span class="op">:=</span> <span class="st">"from_coef"</span><span class="op">]</span>
<span class="va">coef_irr_data</span>
<span class="co">#&gt;     pr100_ili_lag_1      irr     q025     q975       tag</span>
<span class="co">#&gt;  1:      0.03191717 1.032432 1.024849 1.040071 from_coef</span>
<span class="co">#&gt;  2:      0.02728599 1.027662 1.020114 1.035265 from_coef</span>
<span class="co">#&gt;  3:      0.02649399 1.026848 1.019306 1.034446 from_coef</span>
<span class="co">#&gt;  4:      0.02850534 1.028916 1.021359 1.036528 from_coef</span>
<span class="co">#&gt;  5:      0.02478480 1.025094 1.017566 1.032679 from_coef</span>
<span class="co">#&gt;  6:      0.02723395 1.027608 1.020061 1.035211 from_coef</span>
<span class="co">#&gt;  7:      0.02211952 1.022366 1.014857 1.029930 from_coef</span>
<span class="co">#&gt;  8:      0.03244756 1.032980 1.025393 1.040623 from_coef</span>
<span class="co">#&gt;  9:      0.03068968 1.031165 1.023592 1.038795 from_coef</span>
<span class="co">#&gt; 10:      0.02624064 1.026588 1.019048 1.034183 from_coef</span>
<span class="co">#&gt; 11:      0.02986668 1.030317 1.022750 1.037940 from_coef</span></code></pre></div>
<p>Add the correct seasons to the data.</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">coef_irr_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">cbind</a></span><span class="op">(</span>season <span class="op">=</span> <span class="va">aggregated_county_to_nation_irr</span><span class="op">$</span><span class="va">season</span>, <span class="va">coef_irr_data</span><span class="op">)</span>
<span class="va">coef_irr_data</span>
<span class="co">#&gt;        season pr100_ili_lag_1      irr     q025     q975       tag</span>
<span class="co">#&gt;  1: 2009/2010      0.03191717 1.032432 1.024849 1.040071 from_coef</span>
<span class="co">#&gt;  2: 2010/2011      0.02728599 1.027662 1.020114 1.035265 from_coef</span>
<span class="co">#&gt;  3: 2011/2012      0.02649399 1.026848 1.019306 1.034446 from_coef</span>
<span class="co">#&gt;  4: 2012/2013      0.02850534 1.028916 1.021359 1.036528 from_coef</span>
<span class="co">#&gt;  5: 2013/2014      0.02478480 1.025094 1.017566 1.032679 from_coef</span>
<span class="co">#&gt;  6: 2014/2015      0.02723395 1.027608 1.020061 1.035211 from_coef</span>
<span class="co">#&gt;  7: 2015/2016      0.02211952 1.022366 1.014857 1.029930 from_coef</span>
<span class="co">#&gt;  8: 2016/2017      0.03244756 1.032980 1.025393 1.040623 from_coef</span>
<span class="co">#&gt;  9: 2017/2018      0.03068968 1.031165 1.023592 1.038795 from_coef</span>
<span class="co">#&gt; 10: 2018/2019      0.02624064 1.026588 1.019048 1.034183 from_coef</span>
<span class="co">#&gt; 11: 2019/2020      0.02986668 1.030317 1.022750 1.037940 from_coef</span></code></pre></div>
<p>rbindlist the two datasets together.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">total_data_irr</span> <span class="op">&lt;-</span> <span class="fu">data.table</span><span class="fu">::</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/rbindlist.html">rbindlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span><span class="va">coef_irr_data</span>, <span class="va">aggregated_county_to_nation_irr</span><span class="op">)</span>, use.names <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
<span class="va">total_data_irr</span><span class="op">[</span>, <span class="va">pr100_ili_lag_1</span> <span class="op">:=</span> <span class="cn">NULL</span><span class="op">]</span>
<span class="va">total_data_irr</span>
<span class="co">#&gt;        season      irr     q025     q975        tag</span>
<span class="co">#&gt;  1: 2009/2010 1.032432 1.024849 1.040071  from_coef</span>
<span class="co">#&gt;  2: 2010/2011 1.027662 1.020114 1.035265  from_coef</span>
<span class="co">#&gt;  3: 2011/2012 1.026848 1.019306 1.034446  from_coef</span>
<span class="co">#&gt;  4: 2012/2013 1.028916 1.021359 1.036528  from_coef</span>
<span class="co">#&gt;  5: 2013/2014 1.025094 1.017566 1.032679  from_coef</span>
<span class="co">#&gt;  6: 2014/2015 1.027608 1.020061 1.035211  from_coef</span>
<span class="co">#&gt;  7: 2015/2016 1.022366 1.014857 1.029930  from_coef</span>
<span class="co">#&gt;  8: 2016/2017 1.032980 1.025393 1.040623  from_coef</span>
<span class="co">#&gt;  9: 2017/2018 1.031165 1.023592 1.038795  from_coef</span>
<span class="co">#&gt; 10: 2018/2019 1.026588 1.019048 1.034183  from_coef</span>
<span class="co">#&gt; 11: 2019/2020 1.030317 1.022750 1.037940  from_coef</span>
<span class="co">#&gt; 12: 2009/2010 1.032471 1.023866 1.039481 aggregated</span>
<span class="co">#&gt; 13: 2010/2011 1.027621 1.019369 1.035196 aggregated</span>
<span class="co">#&gt; 14: 2011/2012 1.026856 1.018481 1.034855 aggregated</span>
<span class="co">#&gt; 15: 2012/2013 1.028740 1.020524 1.036421 aggregated</span>
<span class="co">#&gt; 16: 2013/2014 1.024961 1.016490 1.033019 aggregated</span>
<span class="co">#&gt; 17: 2014/2015 1.027158 1.019107 1.035644 aggregated</span>
<span class="co">#&gt; 18: 2015/2016 1.022271 1.014079 1.030135 aggregated</span>
<span class="co">#&gt; 19: 2016/2017 1.032681 1.024168 1.041026 aggregated</span>
<span class="co">#&gt; 20: 2017/2018 1.031172 1.022759 1.038742 aggregated</span>
<span class="co">#&gt; 21: 2018/2019 1.026409 1.018225 1.034455 aggregated</span>
<span class="co">#&gt; 22: 2019/2020 1.029899 1.021808 1.038152 aggregated</span>
<span class="co">#&gt;        season      irr     q025     q975        tag</span></code></pre></div>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">q</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>
  data <span class="op">=</span> <span class="va">total_data_irr</span>, 
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>
    x <span class="op">=</span> <span class="va">season</span>,
    group <span class="op">=</span> <span class="va">tag</span>, 
    color <span class="op">=</span> <span class="va">tag</span>
  <span class="op">)</span>
<span class="op">)</span> 
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_linerange.html">geom_pointrange</a></span><span class="op">(</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>
    y <span class="op">=</span> <span class="va">irr</span>,
    ymin <span class="op">=</span> <span class="va">q025</span>,
    ymax <span class="op">=</span> <span class="va">q975</span>
  <span class="op">)</span>,
  position <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/position_dodge.html">position_dodge</a></span><span class="op">(</span>width <span class="op">=</span> <span class="fl">0.3</span><span class="op">)</span>
<span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_text</a></span><span class="op">(</span>angle <span class="op">=</span> <span class="fl">90</span><span class="op">)</span>,axis.title.x<span class="op">=</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"Incident risk ratio"</span><span class="op">)</span>
<span class="va">q</span> <span class="op">&lt;-</span> <span class="va">q</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ggtitle</a></span><span class="op">(</span><span class="st">"Incident risk ratio for ILI per season"</span><span class="op">)</span>
<span class="va">q</span></code></pre></div>
<p><img src="intro_files/figure-html/unnamed-chunk-32-1.png" width="576"></p>
<p>As we can see these intervals are very similar.</p>
<p>The benefit of the simulated approach is that this process will be equally easy no matter the complexity of what we want to compute the IRR for. We do not have to take into account the variance-covariance matrix at any stage.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Richard Aubrey White, Aurora Christine Hofman.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
